# MacOS

Базовые модули агента macOS схожи с базовыми модулями агента Windows, но есть отличие: вместо PowerShell используется Python. Таким образом, вместо модуля `scriptimport` присутствует модуль `pythonscript`. Также имеется модуль `loadpymodule` для загрузки целых программ. Загружаемый файл должен представлять собой ZIP-архив, содержащий скрипты, написанные на Python, или пакеты. Обязательно должен присутствовать файл `__init__.py`.

Арсенал самих модулей для macOS куда скромнее, если сравнивать с Windows. Так, модуль `collection/osx/browser_dump` способен извлечь историю запросов браузера, но не покажет куки и пароли. А модули для отслеживания ввода пользователя вовсе работают иначе: кейлоггер `collection/osx/keylogger` сохраняет историю на удаленной машине в файл, который нам приходится скачивать, а для того, чтобы мониторить буфер обмена с помощью модуля `collection/osx/clipboard`, нужно указать ему время работы в секундах.

Но вот что работает безупречно — так это фишинг, а именно модуль `collection/osx/prompt`.

Среди прочего Empire позволяет запустить App Store и попросить пользователя указать пароль, который мы незамедлительно получим.

Несмотря на то что я уже настраивал кейлоггер, как только был введен пароль, он отобразился в окне Empire. Как правило, схема эксплуатации Empire на Mac очень проста и успешно выполнима в 80% случаев:

1. Фишинговое письмо с нагрузкой -> получение Empire-агента.
2. Использование модуля `collection/osx/prompt` -> получение пароля (как правило, sudo).
3. Использование модуля `privesc/multi/sudo_spawn` для получения агента в контексте sudo.
4. Закрепление в системе с использованием модуля `persistence/osx/loginhook`.

Сложилось мнение, что на маках в основном обрабатывают информацию и готовят отчеты. Поэтому единственное, для чего его стоит захватывать, — это наблюдение за пользователем. Вся описанная выше атака занимает по времени не больше 10–15 минут. Даже если пользователь не хочет вводить пароль, на третий-четвертый раз он смирится и все равно его наберет.

Имея учетные данные sudo, можно наблюдать за действиями пользователя с помощью модуля `management/osx/screen_sharing`, который обеспечит тебе VNC. В целом, повторюсь, захват макa — это легко и быстро, и, как правило, основным инструментом атакующего служит фишинг.
