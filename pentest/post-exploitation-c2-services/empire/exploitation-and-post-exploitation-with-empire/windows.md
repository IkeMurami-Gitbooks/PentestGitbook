# Windows

## Базовые опции

К базовым опциям относятся те функции, которые реализованы в Empire без участия сторонних модулей. Так что пробежимся по тем, которые приходится часто применять:

* `sysinfo` — предоставляет информацию о системе на удаленном хосте;
* `download/upload` — позволяет загрузить файлы на удаленный хост или с него (подобные команды реализованы уже, наверное, везде);
* `sleep` — устанавливает интервал обмена сообщениями с агентом. Таким образом, если установить интервал в 60 секунд, то агент будет принимать от оператора команду и загружать ее в очередь, а затем раз в минуту очищать очередь и предоставлять информацию;
* `steal_token` — модуль имперсонации токена доступа;
* `shell [cmd]` — позволяет выполнить команду черед cmd.exe;
* `ps` — выводит список процессов с указанием имени процесса, его PID, пользователя, в контексте которого работает процесс, и занимаемую процессом память;
* `psinject` — внедряет агент в другой процесс;
* `scriptimport` — позволяет загрузить PowerShell-скрипт в память;
* `mimikatz` — простое быстрое выполнение `sekurlsa::logonpasswords`;
* `creds` — локальное хранилище учетных данных (паролей, хешей), предоставляет оперативную работу с ними. Хеши заполняются автоматически при использовании разных модулей, но также возможно их ручное добавление и удаление. К примеру, упомянутая команда `mimikatz` собрала некоторые учетные данные. Давай взглянем на них.

Это не все «быстрые команды» Empire, а, как упоминалось, те, которые мы используем постоянно.

Для подключения дополнительных модулей следует использовать команду `usemodule`, а если тебе необходимо найти какой-то модуль, для этого есть команда `searchmodule`.

## Раздел collection

Давай рассмотрим модули из данного раздела, которыми мы часто пользуемся. Так как почти всегда приходится вытаскивать пароли и данные из браузеров, тут на помощь приходят следующие инструменты:

* collection/ChromeDump;
* collection/FoxDump;
* collection/SharpChromium.

Запустим модуль командой `run` или `execute`. При этом Empire сообщает, что использование данного модуля нарушает правила скрытности, и спрашивает, хотим ли мы продолжить.

В результате мы получаем все куки, историю запросов и сохраненные учетные данные.

Следующие интересные возможности — искать файлы с помощью модуля `collection/file_finder` и получить дамп нужного процесса с помощью модуля `collection/minidump`. А для отслеживания вводимой пользователем информации можно легко активировать кейлоггер — `collection/keylogger`. Для примера откроем блокнот и напишем слово `test` — это действие будет зафиксировано Empire.

С помощью `collection/clipboard_monitor` мы отслеживаем, что попадает в буфер обмена.

Наконец, самые замечательные функции этого раздела связаны с фишингом. Когда нам необходимо получить пароль и все потенциальные точки входа не прошли проверку, можно «попросить» у пользователя его учетные данные! Сделать это помогают модули `collection/prompt` или `collection/toasted`. Я приведу пример использования `toasted`: на экране юзера выводится уведомление (можно придумать какие угодно условия, но мы используем перезагрузку, так как никто не захочет прерывать работу с документами), на которое он реагирует. Независимо от его выбора появится окно авторизации, учетные данные из которого мы и получим.

```
usemodule collection/toasted
set ToastTitle "Ваш сеанс работы будет прекращен"
set ToastMessage "Cистема будет перезагружена через 5 минут. Хотите ли вы отложить перезагрузку?"
set Application "Служба обновлений Windows"
set CredBoxTitle "Вы уверены, что хотите перезагрузить ваш ПК?"
set CredBoxMessage "Для выполнения данного действия требуется аутентификация"
run
```

При этом у данных модулей есть параметр `VerifyCreds`, установив который в `True` мы обяжем Empire проверить эти учетные данные на подлинность, перед тем как показать их нам. Если пользователь ввел некорректные учетные данные или просто опечатался, Empire запросит их снова.

## Раздел credentials

Об этом разделе рассказывать особо нечего. Он представляет собой полностью реализованное на PowerShell и вставленное в Empire программное обеспечение mimikatz.

Использовать этот инструмент проще простого, поэтому переходим к следующему разделу.

## Раздел management

В этом разделе есть несколько крутых фишек. Первая из них — это легкое включение и отключение RDP для пользователя. Для этого применяются модули `management/enable_rdp` и `management/disable_rdp`. Да, Empire снова предупреждает, что это палевно!

В Empire также встроен инструмент [EmailRaider](https://github.com/xorrior/EmailRaider), предназначенный для просмотра и отправки фишинговых писем с помощью собственного клиента Outlook от имени пользователя. На самом деле из большого списка довольно мощных модулей `management/mailraider/` мы пользуемся только одним, который отвечает за отправку писем, — `management/mailraider/send_mail`.

С использованием этого инструмента мы заполняем текст сообщения и делаем рассылку. Как правило, получив письмо от известного отправителя или другого сотрудника компании, жертва охотнее запустит файл (пусть и подозрительный) или перейдет по ссылкам.

И последний модуль, который используется для наблюдения, — `management/vnc`. Запустим у себя VNC-прослушиватель (я использую Remmina) и выполним обратное подключение.

## Раздел privesc

Раздел с повышением привилегий полезен только для ограниченного круга быстрых проверок, а также из-за модуля `privesc/getsystem`, который позволяет перейти в контекст SYSTEM. В Empire встроены два известных скрипта: `privesc/sherlock`, который проверит наличие в атакуемой системе CVE-уязвимостей, и модуль `privesc/powerup/allchecks` — он поищет пути повышения привилегий (к примеру, подменить файл службы).

## Раздел situational\_awareness

Это очень полезный раздел, с которого обычно и стоит начинать эксплуатацию. Отметим два важных модуля — `situational_awareness/host/antivirusproduct` и `situational_awareness/host/applockerstatus`. Первый предоставляет информацию об используемых на атакуемом хосте антивирусах, второй дает сведения об AppLocker.

Благодаря модулю `situational_awareness/host/computerdetails` мы можем посмотреть события `4648` (RDP) и `4624` (входы в систему) из журнала событий, а также журналы `AppLocker`, запуск PSScripts и сохраненные сеансы RDP.

Очень часто приходится сканировать SPN в сети, и в этом очень помогает модуль `situational_awareness/network/get_spn`. Похожим образом модули `situational_awareness/network/powerview/get_domain_trust` и `situational_awareness/network/powerview/map_domain_trust` облегчают задачу поиска трастов, так как позволяют рекурсивно перечислять все достижимые доверительные отношения домена с текущей позиции в сети. Но круче всего (по моему мнению) в этом разделе модуль `situational_awareness/network/bloodhound3`.

С помощью этого средства мы загружаем полученные от BloodHound файлы и можем их анализировать на своей локальной машине.

## Раздел persistence

Первым делом упомяну о некоторых методах персистентности, которые были описаны [здесь](https://xakep.ru/2020/05/15/windows-ad-backdoor/), а именно:

* SID History — реализован в модуле `persistence/misc/add_sid_history`;
* SSP — реализован в модуле `persistence/misc/memssp`;
* Skeleton Key — реализован в модуле `persistence/misc/skeleton_key`.

Но перечисленные методы — это пользовательская персистентность. Она нам понадобится, когда пользователь выключит или перезагрузит компьютер, чтобы мы смогли войти и снова запустить сеанс Empire. Но чтобы избежать подобного неудобства, в Empire есть и свои модули персистентности сеанса. Мы используем один из двух модулей: `persistence/elevated/registry` или `persistence/elevated/wmi`, разница только в том, что первый основан на закреплении через реестр, а второй через WMI.

Empire сообщает, что мы успешно закрепились. Для примера посмотрим список агентов и перезагрузим систему. После включения ПК у нас появился новый агент!

С Windows все, а теперь давай посмотрим, что мы можем получить от Empire при эксплуатации других систем.
