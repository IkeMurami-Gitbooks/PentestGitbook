# Registry Autoruns

## Intro

Реестр Windows - очень привлекательная цель для сохранения с повышением привилегий.

As a very simple example, let's have a look at Image File Execution Options which is a [popular](https://www.rapid7.com/db/modules/post/windows/manage/sticky\_keys) [method](http://www.labofapenetrationtester.com/2012/05/fun-with-sticky-keys-utilman-and.html) of running a payload as SYSTEM using 'sticky keys'.&#x20;

&#x20;The idea is to modify the ACL of the Registry key responsible for Remote Registry (HKLM:\ SYSTEM\CurrentControlSet\Control\SecurePipeServers\winreg) and for sethc.exe (HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe) to be able to change registry remotely without needing admin privileges. To be able to trigger this remotely on a RDP logon session, NLA needs to be disabled by modifying (HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp).

## Пример

Запускаем команды ниже с привилегиями администратора на интересующей машине для установки registry key permissions:

```
Set-RemoteRegistryPermissions -SamAccountName labuser -ComputerName ops-mssql -Verbose 
Set-RegistryImageFileExecution -SamAccountName labuser -ComputerName 
```

Запускаем следующие команды как пользователь labuser для установки payload для sethc и отключения NLA:

```
Invoke-RegistryAbuse -ComputerName ops-mssql -Method ImageFileExecution -Verbose
```

Теперь подключаемся к машине по RDP и пять раз нажимаем Shift для получения командной строки с привилегиями SYSTEM.

## Notes

Конкретный метод, который мы использовали, не очень тихий (даже некоторые AV-файлы помечают модификацию раздела реестра Image File Execution Options) и фактически снижает безопасность целевой машины. Поэтому, пожалуйста, используйте это осторожно в реальной операции.

Реализация более совершенного выполнения команд на основе registry key - это то, что находится в будущих целях инструмента RACE.
