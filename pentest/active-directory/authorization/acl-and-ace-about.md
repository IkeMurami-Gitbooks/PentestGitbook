# ACL & ACE About

Пользователя аутентифицировали, теперь надо допустить пользователя к ресурсам. Как понять, к чему пользователь может обратиться?

## Определения

**SID** - [Security ID](https://ru.wikipedia.org/wiki/%D0%98%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80\_%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%B8) - структура данных переменной длины, которая идентифицирует учётную запись пользователя, группы, службы, домена или компьютера

**ACL** - Access Control List - определяет права доступа к объектам - Это массив записей **ACE.** Для каждого защищаемого объекта есть два списка **ACL - DACL и SACL**.

**ACE** - Access Control Entry - запись управления доступом. Определяет способ взаимодействия **SID** с защищаемым объектом. Может разрешать или запрещать доступ для определенного **SID**. Каждая структура **ACE** содержит **SID** и набор масок содержащий права доступа для этого **SID**.

**DACL** - указывает пользователей или группы, которым разрешен доступ к объектам, и тип этого доступа.

**SACL** - указывает условия при которых генерируется события безопасности.

## Security descriptor (SID)

Делается это по SIDу. Каждый объект в базе AD имеет SID (свойство `NTSecurityDescriptor`).&#x20;

SID содержит:

* SID of **principal** that is the object owner
* SID of the owner **primary group**
* (Optional) **DACL** (Discretionary Access Control List)
* (Optional) **SACL** (System Access Control List)

Пример получения SID для пользователя

```
PS C:\> $(Get-ADUser anakin -Properties nTSecurityDescriptor).nTSecurityDescriptor | select Owner,Gro
up,Access,Audit | Format-List

Owner  : CONTOSO\Domain Admins
Group  : CONTOSO\Domain Admins
Access : {System.DirectoryServices.ActiveDirectoryAccessRule, System.DirectoryServices.ActiveDirectoryAccessRule,
         System.DirectoryServices.ActiveDirectoryAccessRule, System.DirectoryServices.ActiveDirectoryAccessRule...}
Audit  :
```

Есть два ACL — SASL и DACL.

## ACEs

В ACE перечислено:

* ACE type: allow / deny / logging access
* Inheritance: ACE унаследован?
* Principal / Identity: Indicates the principal (user/group) for which the ACE is applied. The principal SID is stored.
* Rights: Indicates the type of access the ACE is applying.
* Object type: A [GUID](https://en.wikipedia.org/wiki/Universally\_unique\_identifier) that indicates an extended right, property, or child object depending on the Access Mask flags. Is set to zero if not used.
* Inheritance type: The type of object class that can inherit the ACE from this object.

ACE для аккаунта пользователя:

```powershell
PS C:\Users\Administrator> $(Get-ADUser anakin -Properties nTSecurityDescriptor).nTSecurityDescriptor.Access[0]

ActiveDirectoryRights : GenericRead
InheritanceType       : None
ObjectType            : 00000000-0000-0000-0000-000000000000
InheritedObjectType   : 00000000-0000-0000-0000-000000000000
ObjectFlags           : None
AccessControlType     : Allow
IdentityReference     : NT AUTHORITY\SELF
IsInherited           : False
InheritanceFlags      : None
PropagationFlags      : None

```

Если DAST не имеет ACE, то никто не может получить доступ к объекту.

## Rights

The [following rights](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584) can be specified in a ACE:

* **Delete**: Delete the object.
* **ReadControl**: Read the security descriptor, except the SACL.
* **WriteDacl**: Modify the object DACL in the security descriptor.
* **WriteOwner**: Modify the object owner in the security descriptor.
* **CreateChild**: Create child objects. For containers.
* **DeleteChild**: Delete child object. For containers.
* **ListContents**: List child objects. For containers. The object is hidden from user if this right nor ListObject are not granted.
* **ReadProperty**: Read the property or [property set](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/177c0db5-fa12-4c31-b75a-473425ce9cca) specified in object type. If object type is zero, then all properties can be read. It does not allow to read the [confidential properties](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/7c1cdf82-1ecc-4834-827e-d26ff95fb207).
* **WriteProperty**: Modify the property specified in object type. If object type is zero, then all properties can be modified.
* **WritePropertyExtended**: Execute a [validated write](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/20504d60-43ec-458f-bc7a-754eb64446df). Maybe the most interesting [validated write](https://docs.microsoft.com/en-us/windows/win32/adschema/validated-writes) is the [Self-Membership](https://docs.microsoft.com/en-us/windows/win32/adschema/r-self-membership) for groups, that allows to add your current user to the group with the ACE.
* **DeleteTree**: Delete all the child objects with a delete-tree operation.
* **ListObject**: List the object. The object is hidden from user if this right nor ListContents are not granted.
* **ControlAccess**: Special permission that can be interpreted in many different ways, based on the object type. In case the object type is a GUID of a [confidential property](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/e6685d31-5d87-42d0-8a5f-e55d337f47cd), it gives permission to read it. If is the GUID of an [extended right](https://docs.microsoft.com/en-us/windows/win32/adschema/extended-rights) registered in the database schema, then the right is given. In case the object type is null (GUID is all zeros) then all the extended rights are granted.

There are also some generic rights that encompass several rights:

* **GenericRead**: ReadControl, ListContents, ReadProperty (all), ListObject.
* **GenericWrite**: ReadControl, WriteProperty (all), WritePropertyExtended (all).
* **GenericExecute**: ReadControl, ListContents.
* **GenericAll**: Delete, WriteDacl, WriteOwner, CreateChild, DeleteChild, DeleteTree, ControlAccess (all), GenericAll, GenericWrite.

There are many [extended rights](https://docs.microsoft.com/en-us/windows/win32/adschema/extended-rights), but here are ones of the most interesting:

* [User-Force-Change-Password](https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password): Change the user password without knowing the current password. For user objects. Do not confuse with [User-Change-Password](https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password) right, that requires to know the password to change it.
* [DS-Replication-Get-Changes](https://docs.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes): To replicate the database data. For the domain object. Required to perform dcsync.
* [DS-Replication-Get-Changes-All](https://docs.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-all): To replicate the database secret data. For the domain object. Required to perform dcsync.

DS-Replication-Get-Changes-All right in domain:

```
PS C:\Users\Administrator\Downloads> (Get-Acl 'AD:\DC=contoso,DC=local').Access[49]

ActiveDirectoryRights : ExtendedRight
InheritanceType       : None
ObjectType            : 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
InheritedObjectType   : 00000000-0000-0000-0000-000000000000
ObjectFlags           : ObjectAceTypePresent
AccessControlType     : Allow
IdentityReference     : CONTOSO\Domain Controllers
IsInherited           : False
InheritanceFlags      : None
PropagationFlags      : None
```

Локально для объектов (файлы, директории, сервисы, процессы, ключи реестра) на компьютере так же действуют ACL (например, для файлов). Так как группа Domain Admins включена в локальную группу Administrators, то админы домена имеют доступ ко всем файлам на Windows машине.
