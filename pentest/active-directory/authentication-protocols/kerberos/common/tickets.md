# Tickets

## ST / TGS

**ST** - Service Ticket, который клиент представляет AP / сервису / principal, чтобы получить к нему доступ. KDC выдает ST для клиентов, которые их запрашивают.

Часто ST называют TGS (Ticket-Granting Service). Согласно RFC4120 TGS относится к службе, которая предоставляет ST.

В AD клиент может запросить ST для любого сервиса, зарегистрированного в базе домена (даже если клиент не может получить доступ к службе или служба не запущена).

ST включает в себя информацию о клиенте, который должен быть аутентифицирован, и сеансовый ключ для создания канала передачи данных. Тикет зашифрован на ключе того сервиса, к которому должен быть осуществлен доступ (target principal, обычно это служба).

Несколько моментов:

* Если знаем ключ пользователя (получается из пароля), можем создать любой тикет для доступа к сервисам этого пользователя (которые он запустил). Такой тикет называется **Silver Ticket**. Например, если знаем пароль для аккаунта на компе (хранится в LSA Secrets на тачке), мы можем создать Silver Ticket для SMB службы тачки и подключиться как администратор к машине. Можно заметить, что KDC Signature тикета PAC подписана на KDC ключе, следовательно это не прямо настоящий тикет. Однако KDC Signature не проверяется службами.
* Если у пользователя несколько сервисов, то все тикеты будут подписаны на одном ключе. Следовательно, можно попробовать заменить незашифрованную часть тикета, указывающую на target service (`sname`). Этот тикет будет работать для другого сервиса. Например, мы получили TGS тикет для администратора для MSSQL базы на машине A (SPN=MSSQLSvc\machineA); меняем службу на SMB-сервис на этой же машине (SPN=CIFS\machineA) и получаем доступ к machineA.

## TGT

Для запроса TGS, пользователь должен предоставить другой тип тикетов — TGT (Ticket Granting Ticket). TGT — это как ST для KDC.

Зашифрован на ключе владельца сервиса — аккаунт `krbtgt` в домене — так же называемый KDC Key. Если мы получим ключ аккаунта krbtgt (хранится в базе домена), мы сможем создать свои TGT тикеты, известные как **Golden Ticket**.

После того, как создали тикет для какого-то клиента, мы можем выдать себя за любого пользователя домена, включая Administrators.&#x20;

The Golden tickets can even used to [compromise the entire forest](https://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/) by setting special privileged SIDs in the PAC, like [Enterprise Admins](https://zer1t0.gitlab.io/posts/attacking\_ad/#administrative-groups). This can be done because the PAC contains the security data related to the user and it is not verified if the information is true (at least until the ticket [is 20 minutes old](https://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html)), so you can add any user to any group inside of the ticket, and even create tickets for non-existent users.

Чтобы получить TGT, пользователь обычно должен пройти аутентификацию в KDC, используя его учетные данные.



