# Kerberos Delegation

## About

Делегирование позволяет переиспользовать кредсы конечного пользователя для доступа к ресурсам, размещенным на разных серверах. Например, сервер приложения или базы данных. Это в основном используется для двойных прыжков (Когда надо выполнить следующий проброс кредсов: ServerA -> ServerB -> ServerC, подробнее: [здесь](https://docs.microsoft.com/ru-ru/powershell/scripting/learn/remoting/ps-remoting-second-hop)).&#x20;

Делегирование в Kerberos есть двух типов - **ограниченное** и **неограниченное** (до Windows Server 2003, это был единственный вариант).

При **неограниченном** делегировании пользователь **передает** службе **свой TGT**.

При **ограниченном** делегировании используется механизм-расширение Service for User (**S4U**), который позволяет запрашивать ST пользователя без TGT пользователя и только для определенных разрешенных служб.

## Неограниченное делегирование Kerberos

![](<../../../../.gitbook/assets/изображение (3) (2).png>)

1. Пользователь предоставляет креды DC
2. DC возвращает TGT
3. Пользователь запрашивает TGS для веб-сервиса на веб-сервере
4. DC предоставляет TGS
5. Пользователь отправляет TGT и TGS веб-серверу
6. Веб-сервер service account использует пользовательский TGT в запросе у DC на получение TGS для сервера базы данных
7. Веб-сервер service account устанавливает соединение с сервером базы данных как пользователь

Неограниченное делегирование позволяет запрашивать доступ (если был скомпрометирован веб-сервер service account) к любому сервису в домене от имени пользователя.

## Ограниченное делегирование Kerberos

Для большего контроля MS предложил два расширения Kerberos протокола — Service for User (`S4U`):

* Service for User to Proxy (`S4U2proxy`)
* Service for User to Self (`S4U2self`)

Благодаря этим расширениям, сервис может получить доступ от лица пользователя только к определенным сторонним сервисам. При этом TGT пользователя не требуется (соответственно, он не будет хранится на стороне сервиса).

### S4U2Proxy

Расширение `S4U2proxy` (Service for User to Proxy) позволяет службе запрашивать ST для другой службы от имени клиента, используя клиентский ST, который был отправлен службе, вместо клиентского TGT. При этом, запросить ST можно только для ранее определенного списка служб.

Эти сервисы можно узнать благодаря атрибутам:

* `msDS-AllowedToDelegateTo` — атрибут у пользователя, который содержит список `SPN` (= сервисов), для которых он (и его сервисы) могут запросить доступ для других пользователей. Этот список сервисов используется для классического ограниченного делегирования. Для изменения `msDS-AllowedToDelegateTo` требуются привилегии `SeEnableDelegationPrivilege`.
* The service user account is listed in the in the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of the target service user account. This **list of users** is used in Resource Based Constrained Delegation (RBCD).

#### Example of msDS-AllowedToDelegateTo

Пример получения сервисов, к которым пользователь `anakin` может запросить доступ для других пользователей:

```powershell
PS C:\Users\Administrator> get-aduser anakin -Properties msDS-AllowedToDelegateTo

DistinguishedName        : CN=Anakin,CN=Users,DC=contoso,DC=local
msDS-AllowedToDelegateTo : {HTTP/webserver, HTTP/webserver.contoso.local}
SamAccountName           : anakin
SID                      : S-1-5-21-1372086773-2238746523-2939299801-1103
UserPrincipalName        : anakin@contoso.local
```

**Важно**: Так же, `anakin`, получив чей-то тикет к сервису `HTTP/webserver`, может заменить имя службы на любое другое имя службы (которая принадлежит тому же пользователю, что и `HTTP/webserver`), тк они подписаны на одном ключе!

Например, если `webserver$` —  владелец сервиса `HTTP/webserver`, то `anakin` может запросить тикет для `HTTP/webserver` от имени клиента и использовать его для доступа к SMB серверу `webserver` от имени клиента, заменив SPN на `cifs/webserver`.

#### Example of msDS-AllowedToActOnBehalfOfOtherIdentity

```powershell
PS C:\Users\Administrator> get-aduser han -Properties PrincipalsAllowedToDelegateToAccount,msDS-AllowedToActOnBehalfOfOtherIdentity


DistinguishedName                        : CN=Han,CN=Users,DC=contoso,DC=local
Enabled                                  : True
GivenName                                : Han
msDS-AllowedToActOnBehalfOfOtherIdentity : System.DirectoryServices.ActiveDirectorySecurity
Name                                     : Han
ObjectClass                              : user
ObjectGUID                               : 356a7fb7-6cc0-4e09-a77f-b64e1677f2a8
PrincipalsAllowedToDelegateToAccount     : {CN=Anakin,CN=Users,DC=contoso,DC=local}
SamAccountName                           : han
SID                                      : S-1-5-21-1372086773-2238746523-2939299801-1109
Surname                                  :
UserPrincipalName                        : han@contoso.local
```

Пользователь `han` позволяет пользователю `anakin` делегирование всех своих служб. Получается, `anakin` может делать запрос ко всем службам `han` от лица других пользователей.

#### S4U2Proxy Process

```
                KDC
                .---. <-----2) TGS-REQ--------------------.
               /   /|    + SPN: MSSQLSvc/dbsrv            |
              .---. |    + TGT websrv$                    |
              |   | '    + ST client > http/websrv        |
              |   |/                                      |
              '---'  >-----3) TGS-REP------------------.  |
                       + ST client > MSSQLSvc/dbsrv    v  ^
                                                      .---.
  ____                                               /   /|
 |    | >-----------1) AP-REQ---------------------> .---. |
 |____|     + ST client > http/websrv               |   | '
 /::::/                                             |   |/ 
 client                                             '---'  
                                                    websrv
                .---.                                  v
               /   /|                                  |
              .---. |<-----4) AP-REQ-------------------'
              |   | '   + ST client > MSSQLSvc/dbsrv
              |   |/ 
              '---'  
              dbsrv
```

#### S4U2Proxy across domains

Moreover, it also possible to use S4U2proxy across domains, however, in this case [only Resource Based Constrained Delegation can be used](https://docs.microsoft.com/en-us/windows-server/security/kerberos/kerberos-constrained-delegation-overview#resource-based-constrained-delegation-across-domains).

```
                                           KDC foo.com
       .--------------1) TGS-REQ-------------------> .---.
       |          + SPN: MSSQLSvc/dbsrv.bar.com     /   /|
       |          + TGT websrv$ > foo.com          .---. |
       |          + ST client > http/websrv        |   | '
       |                                           |   |/ 
       |   .----2) TGS-REP-----------------------< '---'  
       |   |  + TGT websrv$ (client) > bar.com     ^   v
       ^   v                                       |   |
        .---.                                      |   |
       /   /| >----3) TGS-REQ----------------------'   |
      .---. |      + SPN: krbtgt/bar.com               |
      |   | '      + TGT websrv$ > foo.com             |
      |   |/                                           |
      '---'   <-----4) TGS-REP-------------------------'
      websrv        + TGT websrv$ > bar.com                      .---.
    (foo.com)                                                   /   /|
      ^  v  v                                                  .---. |
      |  |  '-------------7) AP-REQ--------------------------> |   | '
      |  |          + ST client > MSSQLSvc/dbsrv.bar.com       |   |/ 
      |  |                                                     '---'  
      |  '-------5) TGS-REQ-----------------------> .---.      dbsrv
      |      + SPN: MSSQLSvc/dbsrv.bar.com         /   /|    (bar.com)
      |      + TGT websrv$ > bar.com              .---. |
      |      + TGT websrv$ (client) > bar.com     |   | '
      |                                           |   |/ 
      '---6) TGS-REP----------------------------< '---'  
        + ST client > MSSQLSvc/dbsrv.bar.com   KDC bar.com
```

### S4U2Self

Это расширение позволяет сервису запрашивать тикеты для самого себя от лица пользователя, которые потом могут быть использованы в S4U2Proxy.

Это расширение позволяет осуществить делегирование Kerberos для клиентов, которые не поддерживают протокол Kerberos. Также это расширение известно как Protocol transition.

In order to be able to use S4U2self, the KDC checks the [UserAccountControl](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties) TRUSTED\_TO\_AUTH\_FOR\_DELEGATION flag of the service user account. In order to modify this flag, the [SeEnableDelegationPrivilege](https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/) is required.

#### S4U2self process

```
                                                                KDC
                          .---. >---2) TGS-REQ-------------->  .---.
                         /   /|     + SPN: HTTP/websrv        /   /|
  ____                  .---. |     + For user: client       .---. |
 |    | >-1) SPNEGO-->  |   | '     + TGT websrv$            |   | '
 |____|     (NTLM)      |   |/                               |   |/ 
 /::::/                 '---'  <----3) TGS-REP-------------< '---'  
 client                websrv   + ST client > HTTP/websrv
```

#### S4U2self across domains

```
                                                           ____       
                                                          |    |
                                   .-----1) SPNEGO------< |____|
                                   |       (NTLM)         /::::/
                                   |                   client (bar)
                                   |
                                   |
  foo KDC                          v                                    bar KDC
   .---. <----2) TGS-REQ------<  .---. >---------4) TGS-REQ------------>  .---.
  /   /|  + SPN: krbtgt/bar     /   /|        + SPN: HTTP/websrv         /   /|
 .---. |  + TGT websrv$ > foo  .---. |        + For user: client        .---. |
 |   | '                       |   | '        + TGT websrv$ > bar       |   | '
 |   |/                        |   |/                                   |   |/ 
 '---'  >-----3) TGS-REP-----> '---'  <----------5) TGS-REP-----------< '---'  
 v   ^   + TGT websrv$ > bar  websrv    + TGT websrv$ (client) > foo
 |   |                         (foo)
 |   |                         v   ^
 |   |                         |   |
 |   '--<<--6) TGS-REQ---<<----'   |                  
 |  + SPN: HTTP/websrv             | 
 |  + For user: client             |     
 |  + TGT websrv$ (client) > foo   |
 |                                 |
 '----->>---7) TGS-REP---->>-------'                
   + ST client > HTTP/websrv
```

### S4U2self и S4U2proxy вместе

```
                                               KDC
   .------>>----1) TGS-REQ----->>---------------> .---.
   |            + SPN: HTTP/websrv               /   /|
   |            + For user: admin               .---. |
   |            + TGT websrv$                   |   | '
   |                                            |   |/ 
   |   .--<<----2) TGS-REP-----<<-------------< '---'  
   |   |        + ST admin > HTTP/websrv        ^   v
   |   |                                        |   |
   |   |                                        |   |
   ^   v                                        |   |
   .---. >->>---3) TGS-REQ----->>---------------'   |
  /   /|        + SPN: MSSQLSvc/dbsrv               |
 .---. |        + TGT websrv$                       |
 |   | '        + ST admin > HTTP/websrv            |
 |   |/                                             |
 '---'  <--<<---4) TGS-REP-----<<-------------------'
 websrv         + ST admin > MSSQLSvc/dbsrv
   v
   |
   |                                      .---.
   |                                     /   /|
   '------------5) AP-REQ-------------> .---. |
       + ST admin > MSSQLSvc/dbsrv      |   | '
                                        |   |/ 
                                        '---'  
                                        dbsrv
```

## Запретить делегирование

Есть два способа запретить делегирование для аккаунта пользователя (тем самым запретить impersonate в Kerberos):

* Установить `NOT_DELEGATED` флаг в атрибуте `UserAccountControl` пользователя
* Добавить пользователя в группу `Protected Users`

Найти такие аккаунты можно с помощью следующего LDAP-запроса

```
(|
  (memberof:1.2.840.113556.1.4.1941:=CN=Protected Users,CN=Users,DC=<domain>,DC=<dom>)
  (userAccountControl:1.2.840.113556.1.4.803:=1048576)
)
```

Или с помощью инструментов `Powerview`, `AD Module` или `ldapsearch`.
