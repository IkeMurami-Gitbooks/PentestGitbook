# Trusts

Пользователи имеют доступ к другим доменам в одном Forest, потому что между ними есть связи, названные **Trusts** (механизм доверия).

{% tabs %}
{% tab title="PowerView" %}
```
Список всех domain trusts для конкретного домена
Get-NetDomainTrust
Get-NetDomainTrust –Domain somedomain.local

Получить trusts в forest
Get-NetForestTrust
Get-NetForestTrust –Forest someforest.local
```
{% endtab %}

{% tab title="AD Module" %}
```
Список всех domain trusts для конкретного домена
Get-ADTrust -Filter *
Get-ADTrust –Identity somedomain.local

Получить trusts в forest
Get-ADTrust -Filter 'msDS-TrustForestTrustInfo -ne "$null"'
```
{% endtab %}

{% tab title="Others" %}
```
// Get the trusts of your domains
$ nltest /domain_trusts
```
{% endtab %}
{% endtabs %}

### Trust direction

В связи Trust есть две стороны — **Trusting** и **Trasted**. Пользователи Trusted-домена могут получать доступ к ресурсам Trusting-домена. Есть еще два связанных понятия — **Trust Direction** (Trusting -> Trusted ; можно встретить понятия **Inbound** или **Incoming Trust**) и **Access Direction** (Trusted -> Trusting ; можно встретить понятия **Outbound** или **Outgoing Trust**).&#x20;

Incoming Trusts позволяют пользователям вашего домена получить доступ к другому домену. Outgoing Trusts — пользователи другого домена могут получить доступ к вашему домену.

#### Пример

Here we can see that our current domain is `poke.mon` (cause of the `(Primary Domain)` attribute) and there are a couple of trusts. The outbound trust with `contoso.local` indicates that its users can access to our domain, `poke.mon`. Moreover, there is a second bidirectional trust with `it.poke.mon` that is a subdomain of `poke.mon` and it is in the same forest.

```
PS C:\Users\Administrator> nltest /domain_trusts
List of domain trusts:
    0: CONTOSO contoso.local (NT 5) (Direct Outbound) ( Attr: foresttrans )
    1: ITPOKEMON it.poke.mon (NT 5) (Forest: 2) (Direct Outbound) (Direct Inbound) ( Attr: withinforest )
    2: POKEMON poke.mon (NT 5) (Forest Tree Root) (Primary Domain) (Native)
The command completed successfully
```

Consequently, if we check the trust of `contoso.local`, we can see an inbound connection from `poke.mon`, which is consistent with the previous information. So users of `contoso.local` can access to `poke.mon`.

```
PS C:\Users\Anakin> nltest /domain_trusts
List of domain trusts:
    0: POKEMON poke.mon (NT 5) (Direct Inbound) ( Attr: foresttrans )
    1: CONTOSO contoso.local (NT 5) (Forest Tree Root) (Primary Domain) (Native)
The command completed successfully
```

### Trust transitivity

Доверие может быть транзитивным (если домены A и B имеют транзитивное доверие между собой и между B и C есть trust, то C может обращаться к A) и не транзитивным (соотв, C не сможет обратиться к A, даже если между A и B настроен trust).

### Trust types

* **Parent-Child** — доверие, создаваемое по умолчанию между родительским доменом и дочерним.
* **Forest** — для предоставления ресурсов между forests: домены в одном Forest могут обратиться к любому домену в другом Forest (при условии, что direction и транзитивность это позволяют). Если имеются ошибки в настройке этого типа доверия, то можно [получить контроль над другим Forest'ом](http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/).
* **External** — A trust to connect to a specific domain that is in a non trusted forest.
* **Realm** — A special trust to connect Active Directory and a non-Windows domain.
* **Shortcut** — установка короткой ссылки на trust между двумя доменами, что не связаны напрямую (чтобы не прописывать цепочки trust'ов)

### Trust keys

Когда используется общение через trusts, технически, общаются два DC между собой. Trust Key — ключ для создания безопасного канала передачи данных (устанавливается при подключении). При создании trust'а создается Trust Account в domain database (имя аккаунта заканчивается на $). Trust Key сохраняется как пароль пользователя Trust Account (NT hash или Kerberos Keys, в зависимости от протокола общения между DC).

Если сможем получить секреты этого аккаунта (NT-hash или Kerberos Keys), сможем создать [Inter-Realm Kerberos Tickets](https://adsecurity.org/?p=1588).
