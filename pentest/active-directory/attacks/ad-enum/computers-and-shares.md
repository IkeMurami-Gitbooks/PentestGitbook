# Computers and Shares

## Enum Computers and Shares

Для каждого компьютера в домене заведен специальный пользователь. Разница между аккаунтом пользователя и аккаунтом компьютера в том, что первый хранится как объект класса User в базе, а второй — как объект класса Computer (подкласс класса User). Имена объектов класса Computer — `hostname + $`.

Объекты класса Computer хранят информацию об ОС в атрибутах `OperatingSystem` или `OperatingSystemVersion`.

{% tabs %}
{% tab title="PowerView" %}
```
# Компьютеры в сети
Get-NetComputer 
Get-NetComputer -FullData

# Все машины, на которых текущий пользователь - локальный админ
Find-LocalAdminAccess -Verbose

# Сетевые ресурсы и файловые серверы
Find-DomainShare
Get-DomainFileServer

# enumerates computers in the current domain with 'outlier' properties, i.e. properties not set from the firest result returned by Get-DomainComputer
Get-DomainComputer -FindOne | Find-DomainObjectPropertyOutlier
```
{% endtab %}

{% tab title="AD Module" %}
```
PS C:\> Get-ADComputer -Filter * | select Name 
PS C:\> Get-ADComputer -Filter * -Properties *

PS C:\> Get-ADObject -LDAPFilter "objectClass=User" -Properties SamAccountName | select SamAccountName

```
{% endtab %}

{% tab title="CMD" %}
```
net share
net view
net view COMPUTER_NAME /all

если политика безопасности запрещает использовать сетевые команды, выручит wmic:
wmic share get /format:list
wmic /node: COMPUTER_NAME share get
```
{% endtab %}
{% endtabs %}

## Enum computers by the standard way

### LDAP

```
~$ ldapsearch -H ldap://192.168.100.2 -x -LLL -W -D "anakin@contoso.local" -b "dc=contoso,dc=local" "(objectclass=computer)" "DNSHostName" "OperatingSystem"
Enter LDAP Password: 
dn: CN=DC01,OU=Domain Controllers,DC=contoso,DC=local
operatingSystem: Windows Server 2019 Standard Evaluation
dNSHostName: dc01.contoso.local

dn: CN=WS01-10,CN=Computers,DC=contoso,DC=local
operatingSystem: Windows 10 Enterprise
dNSHostName: ws01-10.contoso.local

dn: CN=WS02-7,CN=Computers,DC=contoso,DC=local
operatingSystem: Windows 7 Professional
dNSHostName: WS02-7.contoso.local

dn: CN=SRV01,CN=Computers,DC=contoso,DC=local
operatingSystem: Windows Server 2019 Standard Evaluation
dNSHostName: srv01.contoso.local
```

### NetBIOS

Можем использовать [nbtscan](http://www.unixwiz.net/tools/nbtscan.html)&#x20;

Или nmap-скрипт [nbtstat](https://nmap.org/nsedoc/scripts/nbstat.html)&#x20;

```
$ nbtscan 192.168.100.0/24
```

### SMB

Можем использовать [ntlm-info](https://github.com/Zer1t0/ntlm-info) или nmap [smb-os-discovery](https://nmap.org/nsedoc/scripts/smb-os-discovery.html) скрипт.

```
$ ntlm-info smb 192.168.100.0/24
```

## Как найти DC?

```
# By nslookup
PS C:\> nslookup -q=srv _ldap._tcp.dc._msdcs.my.domain.local

# By system tools, like nltest (нужен пользователь)
PS C:\> nltest /dclist:my.domain.local

# By specific ports
$ nmap 192.168.100.2 -Pn -sV -p-
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos
...
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: my.domain.local0., Site: Default-First-Site-Name)
...
```

This output show a lot of ports open. Here is a brief description of the service offer by each port:

* 42 -> [WINS](https://zer1t0.gitlab.io/posts/attacking\_ad/#netbios-name-service): Centralized service to resolve NetBIOS names to IP addresses.
* 53 -> [DNS](https://zer1t0.gitlab.io/posts/attacking\_ad/#dns): Service to resolve DNS names to IP addresses.
* 88 -> [Kerberos](https://zer1t0.gitlab.io/posts/attacking\_ad/#kerberos): Used to provide Kerberos authentication to users.
* 135 -> [RPC](https://zer1t0.gitlab.io/posts/attacking\_ad/#rpc) Endpoint Mapper: RPC service used to find the RPC endpoints for different RPC services.
* 139 -> [NetBIOS](https://zer1t0.gitlab.io/posts/attacking\_ad/#netbios) Session Service: An old alternative to TCP used by Windows computers. It allows to transport protocols like SMB or RPC.
* 389 -> [LDAP](https://zer1t0.gitlab.io/posts/attacking\_ad/#ldap): Used to query/edit the [domain database](https://zer1t0.gitlab.io/posts/attacking\_ad/#database).
* 445 -> [SMB](https://zer1t0.gitlab.io/posts/attacking\_ad/#smb): Used to share files between computers. Also allow RPC calls through named pipes.
* 464 -> [kpasswd](https://zer1t0.gitlab.io/posts/attacking\_ad/#kerberos): Kerberos service used to change users passwords.
* 593 -> [RPC](https://zer1t0.gitlab.io/posts/attacking\_ad/#rpc) over HTTP Endpoint Mapper
* 636 -> [LDAPS](https://zer1t0.gitlab.io/posts/attacking\_ad/#ldap): LDAP with SSL
* 3268 -> [LDAP](https://zer1t0.gitlab.io/posts/attacking\_ad/#ldap) [Global Catalog](https://zer1t0.gitlab.io/posts/attacking\_ad/#global-catalog): A service to query the Global Catalog.
* 3269 -> [LDAPS](https://zer1t0.gitlab.io/posts/attacking\_ad/#ldap) [Global Catalog](https://zer1t0.gitlab.io/posts/attacking\_ad/#global-catalog)
* 5985 -> [WinRM](https://zer1t0.gitlab.io/posts/attacking\_ad/#winrm): Service to manage the machine remotely with CIM objects or Powershell remoting.
* 9389 -> [ADWS](https://zer1t0.gitlab.io/posts/attacking\_ad/#adws): Web service to query/edit the [domain database](https://zer1t0.gitlab.io/posts/attacking\_ad/#database).
* 49152-65535 [RPC](https://zer1t0.gitlab.io/posts/attacking\_ad/#rpc) Endpoints: Random RPC ports where different RPC services/interfaces listen to clients.

Depending on the DC configuration you can also find the port 3389 open, which allows [RDP](https://zer1t0.gitlab.io/posts/attacking\_ad/#rdp) connections or [many other services](https://docs.microsoft.com/en-US/troubleshoot/windows-server/networking/service-overview-and-network-port-requirements).
