# Users

## Identification

Идентифицировать пользователя в системе можно разными способами:

* SamAccountAttribute — логин пользователя в системе
* SID — состоит из SID домена и ID пользователя (RID — Relative ID), например: SID Domain = `S-1-5-21-1372086773-2238746523-293929980`, SID User = `S-1-5-21-1372086773-2238746523-293929980-1103`
* DistinguishedName — идентификатор пользователя в LDAP-нотации

## Enum

{% tabs %}
{% tab title="PowerView" %}
```
Get-NetUser -Domain powershell.local 
Get-NetUser –UserName labuser

Найти всех локальных админов на всех тачках в домене
Invoke-EnumerateLocalAdmin -Verbose
```
{% endtab %}

{% tab title="AD Module" %}
```
Get-ADUser -Filter * -Properties *
Get-ADUser -Filter * | select SamAccountName
 
Get-ADUser -Server ps-dc.powershell.local 
Get-ADUser -Identity labuser
```
{% endtab %}

{% tab title="Others" %}
```
$ net user /domain
```
{% endtab %}
{% endtabs %}

## Secrets

Пароли пользователей не хранятся в открытом виде, они хранятся на DC в виде:

* NT hash (и LM hash для старых аккаунтов)
* Kerberos keys

Для получения доступа к **секретам** **на DC**, надо иметь привилегии администратора (или что подобное) для дампа базы с секретами домена (**DCSync-атака**) или забрать **NTDS.dit** с DC-сервера.

### LM/NT hashes

NT и LM хеши хранятся локально в хранилище **SAM** на винде и в AD NTDS базе для аутентификации локальных и доменных пользователей, соответственно.

LM-хеши крайне не стойки и не используются с Windows Vista / Server 2008.

Есть много инструментов, способных извлекать NT- и LM-хеши, собирают они их в следующем формате `<username>:<rid>:<LM>:<NT>:::`, например:

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6535b87abdb112a8fc3bf92528ac01f6:::
user:1001:aad3b435b51404eeaad3b435b51404ee:57d583aa46d571502aad4bb7aea09c70:::
```

Так как LM-хеш больше не используется, то сохраняется для обратной совместимости хеш от пустой строки `aad3b435b51404eeaad3b435b51404ee`

#### How Can I Use NT-hash?

Хоть NT-хеши — не пароли в чистом виде, для пентестера они крайне полезны, тк используются для аутентификации на Windows-машинах. Могут быть использованы в атаках **Pass-The-Hash** и **Overpass-The-Hash** для выдачи себя за других пользователей.

Так же, можно попробовать перебрать хеши с помощью **hashcat** (если LM-хеш есть, это будет очень быстро).

### Kerberos Keys

Пример их получения из базы Domain Database

```
$ secretsdump.py 'contoso.local/Administrator@192.168.100.2' -just-dc-user anakin
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
contoso.local\anakin:1103:aad3b435b51404eeaad3b435b51404ee:cdeae556dc28c24b5b7b14e9df5b6e21:::
[*] Kerberos keys grabbed
contoso.local\anakin:aes256-cts-hmac-sha1-96:ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e
contoso.local\anakin:aes128-cts-hmac-sha1-96:18fe293e673950214c67e9f9fe753198
contoso.local\anakin:des-cbc-md5:fbba85fbb63d04cb
[*] Cleaning up...
```

These keys can be used in a **Pass-The-Key** attack to retrieve a ticket for the impersonated user. Then you can use that Kerberos ticket to authenticate against different services of the domain on behalf of the user.

## Important Users

По умолчанию, встроенный аккаунт **Administrator** — самый привилегированный в домене. Скомпрометировали его — скомпрометировали весь домен.

**krbtgt** — тоже очень важный аккаунт, тк на его секретах можно шифровать тикеты (в частности TGT), используемые Kerberos'ом для аутентификации пользователей. Если скомпрометировать этот аккаунт, сможем создавать **Golden Tickets**. Обычно, этот аккаунт можем быть скомпрометирован только путем получения Domain Database.

### Поиск УЗ администратора домена

Существует два эффективных метода искать учетные записи с повышенными правами в Active Directory. Первый — стандартный метод перечисления групп, который идентифицирует всех членов обычных групп администраторов Active Directory. В большинстве организаций есть пользовательские группы администраторов — схемы именования могут быть разными, но если искать по слову admin, то, скорее всего, не промахнешься.

```
get-adgroup -filter {GroupCategory -eq 'Security' -AND Name -like "admin"}
```

Второй метод — искать учетки, у которых атрибут `AdminCount` равен единице.

Но учти, что в числе прочего получишь учетки, у которых прав администратора нет. Дело в том, что это значение не сбрасывается автоматически после удаления учетной записи из групп администраторов.

### Скрытая УЗ администратора

Скрытая учетная запись администратора — это учетная запись домена, которая предоставляет администратору доступ к контроллеру домена, серверу обмена или серверу баз данных. Но эта запись не принадлежит к привилегированным группам Active Directory, то есть администраторам домена. Разрешения для таких учеток назначаются напрямую с помощью списков контроля доступа (ACL) для объектов Active Directory.

Часто это учетные записи служб. Они обычно имеют доступ к нескольким системам в среде. При этом такие учетки не получают столько же внимания и таких же строгих политик безопасности, как администраторы домена. В результате они становятся главной целью злоумышленников при «движении вбок» или повышении привилегий.

Для поиска скрытых учетных записей администратора используй тулзу [BloodHound](https://github.com/BloodHoundAD/BloodHound). Полную инструкцию по установке этого инструмента можешь найти [в вики проекта](https://github.com/BloodHoundAD/BloodHound/wiki/Getting-started).

После настройки базы данных и входа в веб-интерфейс BloodHound можно начинать собирать данные Active Directory с помощью BloodHound PowerShell. Вот как запустить команды для поиска доменов в лесу и сохранить CSV в указанную папку:

```
> . .\SharpHound.ps1
> Invoke-BloodHound -SearchForest -CSVFolder C:\Users\Public
```

После загрузки файла у тебя есть большой выбор дальнейших действий. Можно просмотреть всех администраторов домена, глянуть список пользователей с правами локальных администраторов, определить машины с правами администраторов и многое другое.

Таким образом, при просмотре «карты доверительных отношений» и «10 пользователей с большинством прав локальных администраторов» мы сможем определить учетные записи, которые имеют доступ к большинству систем, а также узнать, существуют ли двусторонние отношения доверия между внешними доменами, которые могли бы расширить круг доступных ресурсов.

Другой способ найти скрытые учетные записи администратора — поиск контроллера домена.

1. Ищем группу Domain Controllers.
2. Выбираем «Прямые участники» в разделе «Участники группы»: там отображены все узлы системы контроллера домена в этой группе.
3. Ткнув на один из узлов системы в разделе «Местные администраторы», выбираем «Производные локальные администраторы».

Как видишь, есть две учетные записи, которые имеют локальный доступ администратора к контроллеру домена. Они не входят в группу «Администраторы домена». Поздравляю, мы только что обнаружили две скрытые учетные записи администратора!
