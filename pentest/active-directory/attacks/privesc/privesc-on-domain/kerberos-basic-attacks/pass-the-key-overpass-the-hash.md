# Pass-the-Key / Overpass-the-Hash

Для запроса TGT используем NTLM-хеш или AES-key.

## Чуть подробнее

As you may notice, to request a TGT, the user doesn't need to use its password, but its Kerberos key. Therefore, if an attacker can stealh a Kerberos key (NT hash or AES keys), it can be used in order to request a TGT on behalf of the user, without the need to know the user password.

Commonly in Windows, the Kerberos keys are cached in the lsass process, and them can be retrieved by using the [mimikatz sekurlsa::ekeys](https://github.com/gentilkiwi/mimikatz/wiki/module-\~-sekurlsa#ekeys) command. Also you can [dump the lsass process](https://www.c0d3xpl0it.com/2016/04/extracting-clear-text-passwords-using-procdump-and-mimikatz.html) with tools like [procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump), [sqldumper or others](https://lolbas-project.github.io/#/dump), and extract the keys offline with mimikatz.

In the case of Linux, the Kerberos keys are stored in [keytab](https://web.mit.edu/kerberos/krb5-devel/doc/basic/keytab\_def.html) files in order to be used for the Kerberos service. The keytab file can be usually found in `/etc/krb5.keytab`, or in the value specified by the environment variables `KRB5_KTNAME` or `KRB5_CLIENT_KTNAME`, or specified in the [Kerberos configuration file](https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf\_files/krb5\_conf.html) in `/etc/krb5.conf`.

When the keytab is located you can copy it to your local machine and/or list its keys with [klist](https://web.mit.edu/kerberos/krb5-1.12/doc/user/user\_commands/klist.html) (Kerberos MIT) or [cerbero](https://gitlab.com/Zer1t0/cerbero/#list).

```
$ klist -k -Ke
Keytab name: FILE:/etc/krb5.keytab
KVNO Principal
---- --------------------------------------------------------------------------
   1 r2d2@contoso.local (DEPRECATED:arcfour-hmac)  (0xc49a77fafad6d3a9270a8568fa453003)
```

Once you have the Kerberos keys, you can request a TGT in Windows by using [Rubeus asktgt](https://github.com/GhostPack/Rubeus#asktgt) command.

In a Linux machine the, you can use the [MIT Kerberos utils](https://malicious.link/post/2018/pass-the-hash-with-kerberos/) to create a keytab with the key, and request a TGT, or using the key directly with the [impacket getTGT.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/getTGT.py) script or [cerbero ask](https://gitlab.com/Zer1t0/cerbero#ask) command.

```bash
$ cerbero ask -u contoso.local/Anakin --aes ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e -k 192.168.100.2 -vv
INFO - Request contoso.local/Anakin TGT for contoso.local
INFO - Save contoso.local/Anakin TGT for contoso.local in /root/Anakin.ccache
```

The Kerberos tickets have two formats: **ccache** and **krb**. The ccache is the one used by Linux machines to store the tickets (usually in files). The krb format is used in Windows to store the tickets in the lsass memory, and it is also the format to transmit tickets over the network. You can convert tickets to one format to another by using the [ticket\_converter.py](https://github.com/Zer1t0/ticket\_converter) script or [cerbero convert](https://gitlab.com/Zer1t0/cerbero#convert) command.

```
$ python ticket_converter.py ~/Anakin.ccache ~/Anakin.krb
Converting ccache => kirbi
```

Additionally, you can calculate the Kerberos keys from the user password by using the [cerbero hash](https://gitlab.com/Zer1t0/cerbero#hash) command. Also the AES keys can be calculated with [Get-KerberosAESKey.ps1](https://gist.github.com/Kevin-Robertson/9e0f8bfdbf4c1e694e6ff4197f0a4372) or the NT hash with a [few python lines](https://stackoverflow.com/questions/15603628/how-to-calculate-ntlm-hash-in-python#answer-15603809).

```bash
$ cerbero hash 'Vader1234!' -u contoso.local/Anakin
rc4:cdeae556dc28c24b5b7b14e9df5b6e21
aes128:18fe293e673950214c67e9f9fe753198
aes256:ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e
```
