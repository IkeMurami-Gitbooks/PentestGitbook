# Group Policy Preferences (GPP)

## Настройки групповой политики

В 2006 году инструмент PolicyMaker от Microsoft Bought Desktop Standard был переименован и выпущен вместе с Windows Server 2008 как Group Policy Preferences (GPP, «предпочтения групповой политики»). Одна из наиболее полезных функций GPP — возможность создавать локальных пользователей, настраивать и изменять их учетки, а также сохранять учетные данные в нескольких файлах сценариев:

* карта дисков (Drives.xml);
* источники данных (DataSources.xml);
* конфигурация принтера (Printers.xml);
* создание/обновление сервисов (Services.xml);
* запланированные задачи (ScheduledTasks.xml).

При создании нового предпочтения групповой политики в SYSVOL генерируется связанный XML-файл с соответствующими данными конфигурации. Если в ней указан пароль пользователя, он будет зашифрован AES 256 бит. Но в 2012 году [Microsoft опубликовала в MSDN ключ AES](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN), который можно использовать для расшифровки пароля.

Иными словами, любой авторизованный в домене юзер может найти в общем ресурсе SYSVOL файлы XML, содержащие cpassword, то есть зашифрованный пароль AES.

Быстро найти эти значения можно следующей командой:

```
C:\> findstr /S /I cpassword \\<FQDN>\sysvol\<FQDN>\policy\*.xml 
```

Для расшифрования существует и полностью автоматизированное средство под названием [gpp-decrypt](https://tools.kali.org/password-attacks/gpp-decrypt), которое требует только значение cpassword и уже предустановлено в Kali Linux. Аналогичная утилита для Windows называется [Get-GPPPassword](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1), ее можно отыскать в наборе программ PowerSploit.

Ну а для очень ленивых есть модуль `smb_enum_gpp` из набора Metasploit. Этот инструмент попросит указать только учетные данные пользователей и адрес контроллера домена.

Так мы можем получить пароль локального администратора, и в большинстве случаев он будет работать на всех компьютерах домена.
