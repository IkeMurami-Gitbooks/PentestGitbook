# NTLM Attacks

Link: [https://zer1t0.gitlab.io/posts/attacking\_ad/#ntlm](https://zer1t0.gitlab.io/posts/attacking\_ad/#ntlm)

## NTLM Recon

NTLM can be useful for reconnaissance, since if the [NTLMSSP\_NEGOTIATE\_TARGET\_INFO](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-nlmp/99d90ff4-957f-4c8a-80e4-5bfe5a9a9832) flag is sent in the NEGOTIATE message, then the server will return the TargetInfo field populated with [AvPairs](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e) in the CHALLENGE message, that contain several information related to the server like its hostname and domain name.

This information can be useful to identify the machine when we only know its IP and a NTLM-friendly service like SMB or HTTP is available on the server. This can be used to perform reserve name resolution in networks.

```
$ ntlm-info smb 192.168.100.0/24

Target: 192.168.100.7
NbComputer: WS02-7
NbDomain: CONTOSO
DnsComputer: ws02-7.contoso.local
DnsDomain: contoso.local
Version: 6.1.7601
OS: Windows 7 | Windows Server 2008 R2

Target: 192.168.100.10
NbComputer: WS01-10
NbDomain: CONTOSO
DnsComputer: ws01-10.contoso.local
DnsDomain: contoso.local
DnsTree: contoso.local
Version: 10.0.19041
OS: Windows 10 | Windows Server 2019 | Windows Server 2016
```

It can be used in an internal network, but also from the internet, since some HTTP servers support NTLM, such as [Outlook Web App](https://support.microsoft.com/en-us/office/getting-started-in-outlook-web-app-0062c7be-f8e3-486e-8b14-5c1f793ceefd?ui=en-US\&rs=en-US\&ad=US).

In case of internet this could reveal the name of the internal domain of an organization, that can be useful to know in order to search for keys or password leaks in github or to use it for bruteforcing attacks in VPN gateways panels.

In order to retrieve NTLM information, you can use tools like [NTLMRecon](https://github.com/pwnfoo/NTLMRecon) (can perform HTTP paths bruteforcing) or [ntlm-info](https://gitlab.com/Zer1t0/ntlm-info) (supports HTTP and SMB). You can also identify web endpoints that support NTLM with [the following wordlist](https://gitlab.com/Zer1t0/barrido/-/blob/master/wordlists/ntlm.txt).

## NTLM Brute-force

A bruteforce attack with NTLM can be launch with tools like [hydra](https://github.com/vanhauser-thc/thc-hydra), [nmap](https://nmap.org/nsedoc/scripts/smb-brute.html), [cme](https://github.com/byt3bl33d3r/CrackMapExec/wiki/SMB-Command-Reference#using-usernamepassword-lists), or [Invoke-Bruteforce.ps1](https://github.com/samratashok/nishang/blob/master/Scan/Invoke-BruteForce.ps1).

```
$ cme smb 192.168.100.10 -u anakin -p passwords.txt 
SMB         192.168.100.10  445    WS01-10          [*] Windows 10.0 Build 19041 x64 (name:WS01-10) (domain:contoso.local) (signing:False) (SMBv1:False)
SMB         192.168.100.10  445    WS01-10          [-] contoso.local\anakin:1234 STATUS_LOGON_FAILURE 
SMB         192.168.100.10  445    WS01-10          [-] contoso.local\anakin:Vader! STATUS_LOGON_FAILURE 
SMB         192.168.100.10  445    WS01-10          [+] contoso.local\anakin:Vader1234! (Pwn3d!)
```

Nevertheless, you should be careful, since testing too much passwords for a single account can block it. In this case the SMB response to the AUTHENTICATE message will contain the code STATUS\_ACCOUNT\_LOCKED\_OUT.

Moreover, launching bruteforce attacks generates a lot of network traffic, specially for Active Directory accounts, since the target machine needs to verify the credentials [against the DC](https://en.hackndo.com/ntlm-relay/#session-key).

Also, bruteforcing attacks of domain accounts can be detected by [Windows-ATA](https://docs.microsoft.com/en-us/advanced-threat-analytics/what-is-ata) since this solution examines all the traffic that goes to the DCs.

## Pass-The-Hash

Another famous technique that uses the NTLM protocol is [Pass-The-Hash](https://en.hackndo.com/pass-the-hash/) (PtH). As you may notice, the NTLM calculates the NTLM hash and session key based on the NT hash of the client/user. Therefore, if an attacker knows the client NT hash it can use this hash to impersonate the client in a NTLM authentication, even if the plain password is unknown.

This attack is pretty relevant nowadays since Microsoft included many protections that prevent tools like [mimikatz](https://github.com/gentilkiwi/mimikatz) from retrieving clear-text passwords [from lsass](https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf) process. However, it is still possible to extract the NT hashes for the user accounts, except in case of [credential guard](https://docs.microsoft.com/en-us/archive/blogs/ash/windows-10-device-guard-and-credential-guard-demystified) being enabled (but also can [be byppassed)](https://teamhydra.blog/2020/08/25/bypassing-credential-guard/).

To extract NT hashes from lsass you can use [mimikatz sekurlsa::logonpasswords](https://github.com/gentilkiwi/mimikatz/wiki/module-\~-sekurlsa#logonpasswords) command. Alternatively, you can [dump the lsass process](https://www.c0d3xpl0it.com/2016/04/extracting-clear-text-passwords-using-procdump-and-mimikatz.html) with tools like [procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump), [sqldumper or others](https://lolbas-project.github.io/#/dump), and copy the dump to your local machine to read it with [mimikatz](https://github.com/gentilkiwi/mimikatz), [pypykatz](https://github.com/skelsec/pypykatz) or [read the dump remotely](https://en.hackndo.com/remote-lsass-dump-passwords/) with [lsassy](https://github.com/Hackndo/lsassy).

Furthermore, NT hashes can also be extracted [from the local SAM database](https://www.hackingarticles.in/credential-dumping-sam/) or the [NTDS.dit database in Domain Controllers](https://www.hackingarticles.in/credential-dumping-ntds-dit/).

In Windows machines you may need to [inject the NT hash in a process](https://www.praetorian.com/blog/inside-mimikatz-part1/) with [mimikatz](https://github.com/gentilkiwi/mimikatz) in order to use it to authenticate against remote machines with built-in tools or IT tools like [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec). Additionally, there are special tools like the [Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash) suite that allows to pass the NT hash as a parameter.

```
PS C:\Users\Anakin\Downloads> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # sekurlsa::pth /user:Administrator /domain:contoso.local /ntlm:b73fdfe10e87b4ca5c0d957f81de6863
```

**Важно**: инжектнутый **хеш** можно использовать только для **удаленного** подключения, не для локальной машины!

On the other part, to perform a Pass-The-Hash from a Linux machine, you can use the [impacket](https://github.com/SecureAuthCorp/impacket) suite, whose scripts accept the NT hash directly as a parameter.

```
$ psexec.py contoso.local/Anakin@192.168.100.10 -hashes :cdeae556dc28c24b5b7b14e9df5b6e21
```

Invoke-TheHash Usage Example:

```
PS C:\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS C:\Invoke-TheHash> Invoke-SMBExec -Target TARGET-MACHINE -Domain VERIZONE -Username someuser -Hash cdeae556dc28c24b5b7b14e9df5b6e21 -Command "net localgroup Administrators VERIZONE\myuser /add" -Verbose
```

## NTLM Relay

Let's talk now about one of the most famous attacks that involve NTLM, the [NTLM Relay](https://en.hackndo.com/ntlm-relay/) attack.

The NTLM Relay attack consist of an attacker that performs a Person-in-The-Middle and takes advantage of its intermediary position to redirect the NTLM authentication to a server of its interest to get an authenticated session.

### SMB

```
$ ntlmrelayx.py -t 192.168.100.10 -smb2support --no-http-server
```

### HTTP and Others

To perform NTLM relay attacks we can use the [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py) scripts, in conjuction with [Responder.py](https://github.com/lgandx/Responder) that allows to perform Person-in-The-Middle attacks. In Windows, other option is to use [Inveigh](https://github.com/Kevin-Robertson/Inveigh) to perform both MiTM and relay. The limitation of this tools is that doesn't allow to perform NTLM relay attack from SMB2 to SMB2 from a Windows machine, since the port 445 is used by the system.

Apart from SMB and LDAP, there are other protocols like MS-SQL or SMTP that support NTLM and could be use for this attack.

### NTLM-SSP Relay

To Exchange Server (base on impacket)

```
 (base on impacket): https://github.com/Arno0x/NtlmRelayToEWS
```

To Any server (base on impacket)

```
ntlmrelayx
https://www.secureauth.com/blog/playing-with-relayed-credentials/
```

## NTLM hashes cracking

Собираем хеши и брутим hashcat'ом.
