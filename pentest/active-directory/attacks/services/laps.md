# LAPS

[Local Administrator Password Solution](https://www.microsoft.com/en-us/download/details.aspx?id=46899) (LAPS) — система, предназначенная для управления паролями локальных администраторов на компьютерах домена. Она позволяет администратору домена периодически менять пароль учетной записи локальных администраторов, делегировать права на чтение и сброс пароля для пользователей или групп Active Directory, а также обеспечивает хранение паролей в расширенном атрибуте объекта компьютера в Active Directory. Система состоит из трех компонентов: агента, модуля PowerShell для настройки системы, Active Directory для хранения паролей.

Есть два способа обнаружить LAPS.

1. На всех хостах, где установлен LAPS, в папке `C:\Program Files\LAPS\CSE\` будет файл `AdmPwd.dll`.
2. Конфигурации LAPS определяются в объектах групповой политики. Командой `Get-DomainGPO -Identity "*LAPS*"` можно поискать любой объект групповой политики, у которого есть слово LAPS в отображаемом имени

Таким образом мы сможем определить, есть ли LAPS на нашей машине. Когда мы выясним, что LAPS на машине точно есть, смотрим конфиг. Конкретная конфигурация для политики LAPS находится в `Registry.pol` в разделе `gpcfilesyspath`. Для декодирования используй инструмент [GPRegistryPolicy](https://github.com/PowerShell/GPRegistryPolicy):

```
Parse-PolFile "\\test.local\SysVol\test.local\Policies\{C8701BA8-56D9-4123-B6B2-FE3FA5031BAA}\Machine\Registry.pol"
```

Теперь найдем все компьютеры, к которым применен этот объект групповой политики. Для этого нам нужно знать GUID этого объекта. Сначала определим подразделения, а потом в каждом подразделении найдем рабочие станции.

```
Get-DomainOU -GPLink "C3801BA8-56D9-4F54-B2BD-FE3BF1A71BAA" -Properties distinguishedname
Get-DomainComputer -SearchBase "LDAP://OU=Workstations,DC=testlab,DC=local" -Properties distinguishedname
Get-DomainComputer -SearchBase "LDAP://OU=Servers,DC=testlab,DC=local" -Properties distinguishedname


```

Мы нашли все компьютеры, на которые распространяется эта конфигурация LAPS. Компонент LAPS PowerShell дает много возможностей. Например, вот такой командой мы можем определить, что `LAB\Workstation Admins` и `LAB\Server Admins` имеют расширенные права в подразделениях Workstations и Servers:

```
Find-AdmPwdExtendedRights -Identity "Workstations" | fl
Find-AdmPwdExtendedRights -Identity "Servers" | fl
```

Теперь легко получить пароль.

```
# Имя получено при Get-DomainComputer
Get-AdmPwdPassword -ComputerName wkstn02 | fl
```

## Other tools

LAPSToolkit (powershell): [https://github.com/leoloobeek/LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit)
