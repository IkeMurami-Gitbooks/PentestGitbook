# MS Exchange

## Структура

```
Mail (OWA): https://mail.example.com/owa/
Exchange Web Services (NTLM SSP): https://mail.example.com/EWS/exchange.asmx
Exchange Control Panel (ECP): https://mail.example.com/ecp/
Exchange ActiveSync (EAS): https://mail.example.com/eas/
```

Подробно описано: [https://habr.com/ru/company/bizone/blog/551228/](https://habr.com/ru/company/bizone/blog/551228/)

## Microsoft Exchange и Outlook при наличии привилегий

Если у злоумышленника есть учетные данные пользователей, то почтовые ящики, считай, тоже скомпрометированы. Если ты выступаешь на атакующей стороне, открывай панель Outlook и делай запросы, по которым могут найтись полезные данные. Например, `логин, пароль, password, pass, credentials, vpn, ssh, root, confidential`.

Этот процесс можно автоматизировать при помощи инструмента [MailSniper](https://github.com/dafthack/MailSniper). Для автоматического обнаружения целевого сервера Exchange и поиска в почтовом ящике user@example.com используй такую команду:

```
Invoke-SelfSearch -OutputCsv local-results.csv -Mailbox user@example.com

Если ящик известен, то такую
Invoke-SelfSearch -Remote -ExchHostname outlook.office365.com -OutputCsv local-results.csv -Mailbox user@example.com

Если у тебя уже есть права администратора Exchange, можно искать по всем почтовым ящикам:
Invoke-GlobalMailSearch -ImpersonationAccount TARGET_USER -ExchHostname Exch01 -OutputCsv global-results.csv
```

## Papers

Подробно: [https://xakep.ru/2020/01/13/windows-ad-escalation/#toc04.](https://xakep.ru/2020/01/13/windows-ad-escalation/#toc04.)

### CVE-2020-17144: MS Exchange 2010

git: [https://github.com/Airboi/CVE-2020-17144-EXP](https://github.com/Airboi/CVE-2020-17144-EXP)

{% file src="../../../../.gitbook/assets/CVE-2020-17144-EXP.zip" %}

### ProxyShell

Уязвимость ProxyShell позволяет неавторизованному пользователю извлекать список пользователей, а также выполнять команды на уровне ОС, что позволяет развивать атаку во внутреннюю сеть.

### ProxyOracle

Уязвимость ProxyOracle позволяет неавторизованному пользователю извлечь учетные данные доменного пользователя и получить доступ к инфраструктуре

ProxyOracle & ProxyShell: [https://github.com/hosch3n/ProxyVulns](https://github.com/hosch3n/ProxyVulns)
