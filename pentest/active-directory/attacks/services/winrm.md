# WinRM

Использование WinRM (Windows Remote Management) для закрепления в сети Заказчика стало своеобразной классикой для пентестера или RedTeam специалиста. Еще несколько лет назад можно было спокойно использовать связку Powershell и WinRM для удаленного выполнения команд. Однако время идет, средства защиты меняются, и было бы наивно думать, что такой популярный метод не будет детектироваться. Естественно, сейчас использовать WinRM через `Invoke-WmiMethod` - это подписать себе смертный приговор и выдать BlueTeam свое местоположение.&#x20;

Однако есть вариант: использовать вместо `Invoke-WmiMethod` командлет `Invoke-WSManAction`

```
Invoke-WSManAction -Action "Create" -ResourceURI "http://schemas.microsoft.com/wbem/wsman/1/wmi/root/cimv2/Win32_Process" -ValueSet @{commandline=""} -ComputerName 
```

Конечно, все можно задетектировать. Однако использование такого командлета на данный момент более безопасно для RedTeam, чем использование `Invoke-WmiMethod`

Делимся с вами полезными ссылками:

[https://github.com/bohops/WSMan-WinRM](https://github.com/bohops/WSMan-WinRM) - проект на гитхабе

[https://bohops.com/2020/05/12/ws-management-com-another-approach-for-winrm-lateral-movement/](https://bohops.com/2020/05/12/ws-management-com-another-approach-for-winrm-lateral-movement/) - подробная статья о всем механизме работы WinRM

Подключение через Login/Pass:&#x20;

```
evil-winrm -i cascade.htb -u s.smith -p sT333ve2
```

## Проверить, что удаленный сервер поддерживает подключение WinRM

```powershell
PS C:\> Test-WSMan -ComputerName TARGET
# Если все ок, получим что то такое

wsmid           : http://schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd
ProtocolVersion : http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd
ProductVendor   : Microsoft Corporation
ProductVersion  : OS: 0.0.0 SP: 0.0 Stack: 3.0

# Пробуем исполнить команду
PS C:\> Invoke-Command -ComputerName TARGET -ScriptBlock {whoami}
DOMAIN\USER
```

## Python

```python
import winrm

s = winrm.Session('192.168.1.2', auth=('user', 'gamer_pass'))
r = s.run_cmd('ipconfig', ['/all'])
>>> r.status_code
0
>>> r.std_out
Windows IP Configuration

   Host Name . . . . . . . . . . . . : WINDOWS-HOST
   Primary Dns Suffix  . . . . . . . :
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
...
>>> r.std_err



https://192.168.1.2:5986/wsman

from winrm.protocol import Protocol

p = Protocol(
    endpoint='https://192.168.1.2:5986/wsman',
    transport='ntlm',
    username=r'user',
    password='gamer_pass',
    server_cert_validation='ignore')
shell_id = p.open_shell()
command_id = p.run_command(shell_id, 'ipconfig', ['/all'])
std_out, std_err, status_code = p.get_command_output(shell_id, command_id)
p.cleanup_command(shell_id, command_id)
p.close_shell(shell_id)

```
