# Детектирование и защита

## Основные советы

Не разрешайте или ограничивайте авторизацию из-под администратора домена на любые машины, кроме контроллеров домена. Если авторизация на какие-то сервера необходимы, то не разрешать другим администраторам авторизоваться на этих машинах.

**Не запускайте** сервисы из-под аккаунта администратора домена. Многие хорошие средства защиты становятся бесполезными из-за переиспользования кредсов.

## Mitigation Kerberoast

* Пароли от Service Account должны быть тяжело угадываемы (более 25 символов)
* Используйте службу управления учетными записями (Managed Service Accounts). Эта служба периодически меняет пароль и делегирование SPN Management
* https://technet.microsoft.com/en-us/library/jj128431(v=ws.11).aspx &#x20;

## Некоторые Event ID:

### Golden Ticket

* 4624: Account Logon
* 4672: Admin Logon

### Silver Ticket

* 4624: Account Logon
* 4634: Account Logoff
* 4672: Admin Logon

### Kerberoast

Security Event ID 4769 - Kerberos Ticket был запрошен

## Защита от атак на Trust Tickets

### Фильтрация SID

* Помогает против атак, использующих SID history attribute (child -> root domain PrivEsc, т.е. DA от дочернего приводим к EA на forest root)
* Включена по-умолчанию на всех inter-forest trusts. Предполагается, что intra-forest trusts безопасны по умочанию (MS рассматривает forest, а не домен, как границу безопасности)
* Но, по скольку, фильтрация SID потенциально может нарушить доступ приложений и пользователей, она часто отключается.

### Выборочная аутентификация

В Inter-forest trust, если додверительная аутентификация настроена, пользователи между trusts не будут автоматически аутентифицированы. Должен быть предоставлен отдельный доступ к доменам и серверам в trusting domain/forest.

### Microsoft  ATA (Advanced Threat Analytics)

* Трафик, направленный к DC, зеркалируется на ATA сенсоры, и пользовательская активность собирается все время - используемые компьютеры, кредсы, логи и тд
* Собираются события 4776 (DC попытался проверить кредсы для учетной записи) для детектирования атак типа перепосылки учетных данных.
* Может обнаруживать аномальные поведения

Применяется для детектирования:

* Разведка: account enum, netsession enum
* Компрометация учетных данных: брут, использование учетных записей с высоким уровнем привилегий / служебных учетных записей, honey token, неиспользуемые протоколы (NTLM и Kerberos)
* Атаки типо перепосылки: учетных данных, хешей, тикетов

Обход ATA

* ATA можно обойти и/или избежать
* Фишка заключается в том, чтобы не общаться с DC как можно дольше и отображать трафик, который мы генерируем как атакующие, легитимным.

### Архитектурные изменения

LAPS (Local Administration Password Solution)

* Централизованное хранилище паролей в AD с периодической рандомизацией, разрешение на чтение к которому может быть управляем
* Хранилище сохраняет данные в открытом виде, но передает в зашифрованном
* Введение в LAPS: [ https://technet.microsoft.com/en-us/mt227395.aspx](https://technet.microsoft.com/en-us/mt227395.aspx)
* Использование фичей LAPS: [https://blog.netspi.com/running-laps-around-cleartext-passwords/](https://blog.netspi.com/running-laps-around-cleartext-passwords/)

PAWs (Privileged Administrative Workstations)

* Защищенная рабочая станция для выполнения важных задач, таких как администрирование контроллеров домена, облачная инфраструктура, важные бизнес-функции и т.д.
* Может обеспечить защиту от фишинговых атак, уязвимостей ОС, атак с повторным использованием учетных данных.
* Несколько стратегий
  * Отдельные привилегии и оборудование для административных и обычных задач
  * Серверы Admin Jump доступны только из PAW
  * Наличие виртуальной машины на PAW для пользовательских задач

ESAE (Enhanced Security Admin Environment)

Выделенный административный forest для управления такими важными активами, как административные пользователи, группы и компьютеры.

Поскольку forest считается границей безопасности, в отличие от домена, эта модель обеспечивает расширенные меры безопасности

Административный forest также называется Red Forest

Административные пользователи в рабочем forest используются как стандартные непривилегированные пользователи в административном forest.

Выборочная аутентификация в Red Forest обеспечивает более строгие меры безопасности при входе пользователей из не административных forests.

## Papers

Securing Privileged Access: https://technet.microsoft.com/en-us/windows-server-docs/security/securing-privileged-access/securing-privileged-access&#x20;

MS Paper - Best Practices for Securing Active Directory: http://aka.ms/bpsadtrd

Защита от детекта:\
[https://xakep.ru/2020/02/14/windows-ad-shuffle/](https://xakep.ru/2020/02/14/windows-ad-shuffle/)\
[https://xakep.ru/2020/03/10/ad-bypass/](https://xakep.ru/2020/03/10/ad-bypass/)

